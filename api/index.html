<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ring.com/api/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>ring - ring</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../css/ansi-colours.css" rel="stylesheet" />
        <link href="../css/jupyter-cells.css" rel="stylesheet" />
        <link href="../css/pandas-dataframe.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "ring";
        var mkdocs_page_input_path = "api.md";
        var mkdocs_page_url = "/api/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../img/icon.svg" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../xml_syntax/">XML Syntax Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Examples / Notebooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/getting_started/">Getting started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/batched_simulation/">Batched simulation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/control/">Control</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/custom_joint_type/">Custom joint type</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/experimental_data/">Experimental data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/error_quaternion/">Error quaternion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/machine_learning/">Machine learning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/visualisation/">Visualisation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/knee_angle_tracking/">Knee angle tracking</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">ring</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#ring">RING</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#src.ring.RING">RING</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#src.ring.ml.ringnet.RING">RING</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rcmg">RCMG</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#src.ring.algorithms.generator.base.RCMG">RCMG</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#system">System</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#src.ring.base.System">System</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#motionconfig">MotionConfig</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#src.ring.algorithms.jcalc.MotionConfig">MotionConfig</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#src.ring.algorithms.jcalc.join_motionconfigs">join_motionconfigs</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#extending-the-rcmg">Extending the RCMG</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#src.ring.algorithms.jcalc.JointModel">JointModel</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#src.ring.algorithms.jcalc.register_new_joint_type">register_new_joint_type</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simulation">Simulation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#src.ring.base.State">State</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#src.ring.algorithms.dynamics.step">step</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#src.ring.base.Transform">Transform</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">ring</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">API</li>
      <li class="breadcrumb-item active">ring</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="api">API<a class="headerlink" href="#api" title="Permanent link">¤</a></h1>
<h2 id="ring">RING<a class="headerlink" href="#ring" title="Permanent link">¤</a></h2>



<div class="doc doc-object doc-function">



<h4 id="src.ring.RING" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">RING</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#src.ring.RING" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">
  
      <p>Creates the RING network.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>lam</code></b>
                  (<code>list[int] | None</code>)
              –
              <div class="doc-md-description">
                <p>parent array, if <code>None</code> must be given via <code>ringnet.apply(..., lam=lam)</code></p>
              </div>
            </li>
            <li>
              <b><code>Ts</code></b>
              –
              <div class="doc-md-description">
                <p>sampling interval of IMU data; time delta in seconds</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code><span title="src.ring.ml.AbstractFilter">AbstractFilter</span></code>
            –
            <div class="doc-md-description">
              <p>ring.ml.AbstractFilter: An instantiation of <code>ring.ml.ringnet.RING</code> with trained
parameters.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>


<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">ring</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">T</span>  <span class="p">:</span> <span class="nb">int</span>       <span class="o">=</span> <span class="mi">30</span>        <span class="c1"># sequence length     [s]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Ts</span> <span class="p">:</span> <span class="nb">float</span>     <span class="o">=</span> <span class="mf">0.01</span>      <span class="c1"># sampling interval   [s]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">B</span>  <span class="p">:</span> <span class="nb">int</span>       <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># batch size</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">lam</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="c1"># parent array</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">N</span>  <span class="p">:</span> <span class="nb">int</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>  <span class="c1"># number of bodies</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">T_i</span><span class="p">:</span> <span class="nb">int</span>       <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">Ts</span><span class="p">)</span> <span class="c1"># number of timesteps</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">T_i</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># where X is structured as follows:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># X[..., :3]  = acc</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># X[..., 3:6] = gyr</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># X[..., 6:9] = jointaxis</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># let&#39;s assume we have an IMU on each outer segment of the</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># three-segment kinematic chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="n">acc_segment1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="n">acc_segment3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">gyr_segment1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">gyr_segment3</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ringnet</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">RING</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">Ts</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yhat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ringnet</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># yhat : unit quaternions, shape = (B, T_i, N, 4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># yhat[b, :, i] is the orientation from body `i` to parent body `lam[i]`</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># use `jax.jit` to compile the forward pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jit_apply</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">ringnet</span><span class="o">.</span><span class="n">apply</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yhat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jit_apply</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># manually pass in and out the hidden state like so</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">initial_state</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yhat</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">ringnet</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># state: final hidden state, shape = (B, N, 2*H)</span>
</code></pre></div>

          <details class="quote">
            <summary>Source code in <code>src/ring/__init__.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">RING</span><span class="p">(</span><span class="n">lam</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ml</span><span class="o">.</span><span class="n">AbstractFilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates the RING network.</span>

<span class="sd">    Params:</span>
<span class="sd">        lam: parent array, if `None` must be given via `ringnet.apply(..., lam=lam)`</span>
<span class="sd">        Ts : sampling interval of IMU data; time delta in seconds</span>

<span class="sd">    Returns:</span>
<span class="sd">        ring.ml.AbstractFilter: An instantiation of `ring.ml.ringnet.RING` with trained</span>
<span class="sd">            parameters.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import ring</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; T  : int       = 30        # sequence length     [s]</span>
<span class="sd">        &gt;&gt;&gt; Ts : float     = 0.01      # sampling interval   [s]</span>
<span class="sd">        &gt;&gt;&gt; B  : int       = 1         # batch size</span>
<span class="sd">        &gt;&gt;&gt; lam: list[int] = [0, 1, 2] # parent array</span>
<span class="sd">        &gt;&gt;&gt; N  : int       = len(lam)  # number of bodies</span>
<span class="sd">        &gt;&gt;&gt; T_i: int       = int(T/Ts) # number of timesteps</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; X = np.zeros((B, T_i, N, 9))</span>
<span class="sd">        &gt;&gt;&gt; # where X is structured as follows:</span>
<span class="sd">        &gt;&gt;&gt; # X[..., :3]  = acc</span>
<span class="sd">        &gt;&gt;&gt; # X[..., 3:6] = gyr</span>
<span class="sd">        &gt;&gt;&gt; # X[..., 6:9] = jointaxis</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # let&#39;s assume we have an IMU on each outer segment of the</span>
<span class="sd">        &gt;&gt;&gt; # three-segment kinematic chain</span>
<span class="sd">        &gt;&gt;&gt; X[:, :, 0, :3]  = acc_segment1</span>
<span class="sd">        &gt;&gt;&gt; X[:, :, 2, :3]  = acc_segment3</span>
<span class="sd">        &gt;&gt;&gt; X[:, :, 0, 3:6] = gyr_segment1</span>
<span class="sd">        &gt;&gt;&gt; X[:, :, 2, 3:6] = gyr_segment3</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; ringnet = ring.RING(lam, Ts)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; yhat, _ = ringnet.apply(X)</span>
<span class="sd">        &gt;&gt;&gt; # yhat : unit quaternions, shape = (B, T_i, N, 4)</span>
<span class="sd">        &gt;&gt;&gt; # yhat[b, :, i] is the orientation from body `i` to parent body `lam[i]`</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # use `jax.jit` to compile the forward pass</span>
<span class="sd">        &gt;&gt;&gt; jit_apply = jax.jit(ringnet.apply)</span>
<span class="sd">        &gt;&gt;&gt; yhat, _ = jit_apply(X)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # manually pass in and out the hidden state like so</span>
<span class="sd">        &gt;&gt;&gt; initial_state = None</span>
<span class="sd">        &gt;&gt;&gt; yhat, state = ringnet.apply(X, state=initial_state)</span>
<span class="sd">        &gt;&gt;&gt; # state: final hidden state, shape = (B, N, 2*H)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="kn">import</span> <span class="nn">warnings</span>

    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">use_100Hz_RING</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_lpf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lpf_cutoff_freq</span><span class="o">=</span><span class="n">ml</span><span class="o">.</span><span class="n">_LPF_CUTOFF_FREQ</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Ts</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">40</span><span class="p">)</span> <span class="ow">or</span> <span class="n">Ts</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">200</span><span class="p">)):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;RING was only trained on sampling rates between 40 to 200 Hz &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but found </span><span class="si">{</span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Ts</span><span class="si">}</span><span class="s2">Hz&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">Ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Ts</span> <span class="o">==</span> <span class="mf">0.01</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_100Hz_RING&quot;</span><span class="p">]:</span>
        <span class="c1"># this set of parameters was trained exclusively on 100Hz data; it also</span>
        <span class="c1"># expects F=9 features per node and not F=10 where the last features is</span>
        <span class="c1"># the sampling interval Ts</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;ml/params/0x1d76628065a71e0f.pickle&quot;</span><span class="p">)</span>
        <span class="n">add_Ts</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this set of parameters was trained on sampling rates from 40 to 200 Hz</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;ml/params/0x13e3518065c21cd8.pickle&quot;</span><span class="p">)</span>
        <span class="n">add_Ts</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">ringnet</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">RING</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">lam</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">lam</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lam</span><span class="p">),</span>
        <span class="n">jit</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;jit&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;RING&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ringnet</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">ScaleX_FilterWrapper</span><span class="p">(</span><span class="n">ringnet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_lpf&quot;</span><span class="p">]:</span>
        <span class="n">ringnet</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">LPF_FilterWrapper</span><span class="p">(</span>
            <span class="n">ringnet</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lpf_cutoff_freq&quot;</span><span class="p">],</span>
            <span class="n">samp_freq</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">Ts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Ts</span><span class="p">,</span>
            <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">ringnet</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">GroundTruthHeading_FilterWrapper</span><span class="p">(</span><span class="n">ringnet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_Ts</span><span class="p">:</span>
        <span class="n">ringnet</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">AddTs_FilterWrapper</span><span class="p">(</span><span class="n">ringnet</span><span class="p">,</span> <span class="n">Ts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ringnet</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div><hr />


<div class="doc doc-object doc-class">



<h4 id="src.ring.ml.ringnet.RING" class="doc doc-heading">
          <code>RING</code>


<a href="#src.ring.ml.ringnet.RING" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">


            <details class="quote">
              <summary>Source code in <code>src/ring/ml/ringnet.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RING</span><span class="p">(</span><span class="n">ml_base</span><span class="o">.</span><span class="n">AbstractFilter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">forward_factory</span><span class="o">=</span><span class="n">make_ring</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="s2">&quot;Untrained RING network&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_lam_factory</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">forward_factory</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">jit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span> <span class="n">static_argnames</span><span class="o">=</span><span class="s2">&quot;lam&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lam</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Providing `X` via in `ringnet.init(X=X)` is required&quot;</span>
        <span class="k">if</span> <span class="n">bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">bs</span> <span class="o">==</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># (T, N, F) -&gt; (1, N, F) for faster .init call</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">lam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">params</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_lam_factory</span><span class="p">(</span><span class="n">lam</span><span class="o">=</span><span class="n">lam</span><span class="p">)</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">bs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">state</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">_apply_batched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_params</span><span class="p">,</span> <span class="n">_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="n">lam</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">_params</span>
        <span class="k">elif</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">_state</span>

        <span class="n">yhat</span><span class="p">,</span> <span class="n">next_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forward_lam_factory</span><span class="p">(</span><span class="n">lam</span><span class="o">=</span><span class="n">lam</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)(</span><span class="n">params</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">next_state</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Path</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">Path</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">pickle_load</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">nojit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RING&quot;</span><span class="p">:</span>
        <span class="n">ringnet</span> <span class="o">=</span> <span class="n">RING</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ringnet</span><span class="o">.</span><span class="n">forward_lam_factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_lam_factory</span>
        <span class="k">return</span> <span class="n">ringnet</span>

    <span class="k">def</span> <span class="nf">_pre_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">if</span> <span class="n">lam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_post_load</span><span class="p">(</span><span class="n">ringnet</span><span class="p">:</span> <span class="s2">&quot;RING&quot;</span><span class="p">,</span> <span class="n">jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RING&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jit</span><span class="p">:</span>
            <span class="n">ringnet</span><span class="o">.</span><span class="n">apply</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">ringnet</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span> <span class="n">static_argnames</span><span class="o">=</span><span class="s2">&quot;lam&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ringnet</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h5 id="src.ring.ml.ringnet.RING.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forward_factory</span><span class="o">=</span><span class="n">make_ring</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#src.ring.ml.ringnet.RING.__init__" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Untrained RING network</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/ml/ringnet.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">forward_factory</span><span class="o">=</span><span class="n">make_ring</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="s2">&quot;Untrained RING network&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">forward_lam_factory</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">forward_factory</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">if</span> <span class="n">jit</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span> <span class="n">static_argnames</span><span class="o">=</span><span class="s2">&quot;lam&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div><h2 id="rcmg">RCMG<a class="headerlink" href="#rcmg" title="Permanent link">¤</a></h2>


<div class="doc doc-object doc-class">



<h4 id="src.ring.algorithms.generator.base.RCMG" class="doc doc-heading">
          <code>RCMG</code>


<a href="#src.ring.algorithms.generator.base.RCMG" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">


            <details class="quote">
              <summary>Source code in <code>src/ring/algorithms/generator/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RCMG</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sys</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">System</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">jcalc</span><span class="o">.</span><span class="n">MotionConfig</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">jcalc</span><span class="o">.</span><span class="n">MotionConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">jcalc</span><span class="o">.</span><span class="n">MotionConfig</span><span class="p">(),</span>
        <span class="n">setup_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">SETUP_FN</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">finalize_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FINALIZE_FN</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">add_X_imus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">add_X_imus_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">add_X_jointaxes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">add_X_jointaxes_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">add_y_relpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">add_y_rootincl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">add_y_rootincl_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">add_y_rootfull</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">add_y_rootfull_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">sys_ml</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">randomize_positions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">randomize_motion_artifacts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">randomize_joint_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">randomize_hz</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">randomize_hz_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">imu_motion_artifacts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">imu_motion_artifacts_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">dynamic_simulation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dynamic_simulation_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">output_transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_output_extras</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_link_number_in_Xy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">disable_tqdm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Random Chain Motion Generator&quot;</span>

        <span class="c1"># add some default values</span>
        <span class="n">randomize_hz_kwargs_defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">add_dt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">randomize_hz_kwargs_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">randomize_hz_kwargs</span><span class="p">)</span>
        <span class="n">randomize_hz_kwargs</span> <span class="o">=</span> <span class="n">randomize_hz_kwargs_defaults</span>

        <span class="n">sys</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">sys</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">sys_ml</span> <span class="o">=</span> <span class="n">sys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">sys_ml</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sys_ml</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_sys</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_build_mconfig_batched_generator</span><span class="p">(</span>
                    <span class="n">sys</span><span class="o">=</span><span class="n">_sys</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">setup_fn</span><span class="o">=</span><span class="n">setup_fn</span><span class="p">,</span>
                    <span class="n">finalize_fn</span><span class="o">=</span><span class="n">finalize_fn</span><span class="p">,</span>
                    <span class="n">add_X_imus</span><span class="o">=</span><span class="n">add_X_imus</span><span class="p">,</span>
                    <span class="n">add_X_imus_kwargs</span><span class="o">=</span><span class="n">add_X_imus_kwargs</span><span class="p">,</span>
                    <span class="n">add_X_jointaxes</span><span class="o">=</span><span class="n">add_X_jointaxes</span><span class="p">,</span>
                    <span class="n">add_X_jointaxes_kwargs</span><span class="o">=</span><span class="n">add_X_jointaxes_kwargs</span><span class="p">,</span>
                    <span class="n">add_y_relpose</span><span class="o">=</span><span class="n">add_y_relpose</span><span class="p">,</span>
                    <span class="n">add_y_rootincl</span><span class="o">=</span><span class="n">add_y_rootincl</span><span class="p">,</span>
                    <span class="n">add_y_rootincl_kwargs</span><span class="o">=</span><span class="n">add_y_rootincl_kwargs</span><span class="p">,</span>
                    <span class="n">add_y_rootfull</span><span class="o">=</span><span class="n">add_y_rootfull</span><span class="p">,</span>
                    <span class="n">add_y_rootfull_kwargs</span><span class="o">=</span><span class="n">add_y_rootfull_kwargs</span><span class="p">,</span>
                    <span class="n">sys_ml</span><span class="o">=</span><span class="n">sys_ml</span><span class="p">,</span>
                    <span class="n">randomize_positions</span><span class="o">=</span><span class="n">randomize_positions</span><span class="p">,</span>
                    <span class="n">randomize_motion_artifacts</span><span class="o">=</span><span class="n">randomize_motion_artifacts</span><span class="p">,</span>
                    <span class="n">randomize_joint_params</span><span class="o">=</span><span class="n">randomize_joint_params</span><span class="p">,</span>
                    <span class="n">randomize_hz</span><span class="o">=</span><span class="n">randomize_hz</span><span class="p">,</span>
                    <span class="n">randomize_hz_kwargs</span><span class="o">=</span><span class="n">randomize_hz_kwargs</span><span class="p">,</span>
                    <span class="n">imu_motion_artifacts</span><span class="o">=</span><span class="n">imu_motion_artifacts</span><span class="p">,</span>
                    <span class="n">imu_motion_artifacts_kwargs</span><span class="o">=</span><span class="n">imu_motion_artifacts_kwargs</span><span class="p">,</span>
                    <span class="n">dynamic_simulation</span><span class="o">=</span><span class="n">dynamic_simulation</span><span class="p">,</span>
                    <span class="n">dynamic_simulation_kwargs</span><span class="o">=</span><span class="n">dynamic_simulation_kwargs</span><span class="p">,</span>
                    <span class="n">output_transform</span><span class="o">=</span><span class="n">output_transform</span><span class="p">,</span>
                    <span class="n">keep_output_extras</span><span class="o">=</span><span class="n">keep_output_extras</span><span class="p">,</span>
                    <span class="n">use_link_number_in_Xy</span><span class="o">=</span><span class="n">use_link_number_in_Xy</span><span class="p">,</span>
                    <span class="n">cor</span><span class="o">=</span><span class="n">cor</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n_mconfigs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size_of_generators</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_mconfigs</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disable_tqdm</span> <span class="o">=</span> <span class="n">disable_tqdm</span>

    <span class="k">def</span> <span class="nf">_compute_repeats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="s2">&quot;how many times the generators are repeated to create a batch of `sizes`&quot;</span>

        <span class="n">S</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size_of_generators</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size_of_generators</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">assert_size</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_mconfigs</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">primes</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`size`=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> is not divisible by number of &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;`mconfigs`=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_mconfigs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">sizes</span> <span class="o">//</span> <span class="n">S</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Batchsize or size too small. </span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">assert</span> <span class="n">sizes</span> <span class="o">%</span> <span class="n">S</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;`size`=</span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s2"> not divisible by </span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">repeats</span> <span class="o">=</span> <span class="n">L</span> <span class="o">*</span> <span class="p">[</span><span class="n">sizes</span> <span class="o">//</span> <span class="n">S</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
                <span class="n">assert_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gens</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;len(`sizes`)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">repeats</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">size</span> <span class="o">//</span> <span class="n">size_of_gen</span>
                <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">size_of_gen</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size_of_generators</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">assert</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">repeats</span>

        <span class="k">return</span> <span class="n">repeats</span>

    <span class="k">def</span> <span class="nf">to_lazy_gen</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">types</span><span class="o">.</span><span class="n">BatchedGenerator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">generators_lazy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_repeats</span><span class="p">(</span><span class="n">sizes</span><span class="p">),</span> <span class="n">jit</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_number_of_executions_required</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">vmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">distribute_batchsize</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">eager_threshold</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">batchsize_thresholds</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">primes</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">primes</span><span class="p">(</span><span class="n">vmap</span><span class="p">))</span>
        <span class="n">n_calls</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">vmap</span> <span class="o">&gt;</span> <span class="n">eager_threshold</span><span class="p">:</span>
            <span class="n">prime</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">primes</span><span class="p">)</span>
            <span class="n">n_calls</span> <span class="o">*=</span> <span class="n">prime</span>
            <span class="n">vmap</span> <span class="o">/=</span> <span class="n">prime</span>

        <span class="k">return</span> <span class="n">n_calls</span>

    <span class="k">def</span> <span class="nf">_generators_ncalls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="s2">&quot;Returns list of unbatched sequences as numpy arrays.&quot;</span>
        <span class="n">repeats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_repeats</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">repeats</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size_of_generators</span><span class="p">))</span>

        <span class="n">reduced_repeats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">repeats</span><span class="p">):</span>
            <span class="n">n_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_executions_required</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">gcd</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">n_call</span><span class="p">,</span> <span class="n">repeat</span><span class="p">)</span>
            <span class="n">n_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gcd</span><span class="p">)</span>
            <span class="n">reduced_repeats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repeat</span> <span class="o">//</span> <span class="n">gcd</span><span class="p">)</span>
        <span class="n">jits</span> <span class="o">=</span> <span class="p">[</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">n_calls</span><span class="p">]</span>

        <span class="n">gens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">repeats</span><span class="p">)):</span>
            <span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">generators_lazy</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">reduced_repeats</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">jits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">gens</span><span class="p">,</span> <span class="n">n_calls</span>

    <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">tree_utils</span><span class="o">.</span><span class="n">PyTree</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
        <span class="s2">&quot;Returns list of unbatched sequences as numpy arrays.&quot;</span>
        <span class="n">gens</span><span class="p">,</span> <span class="n">n_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generators_ncalls</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">generators_eager</span><span class="p">(</span>
            <span class="n">gens</span><span class="p">,</span> <span class="n">n_calls</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disable_tqdm</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">to_folder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">file_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;seq&quot;</span><span class="p">,</span>
        <span class="n">save_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">PyTree</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">pickle_save</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PyTree</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">i</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">replace_elements_w_nans</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">file_prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">file_exists_ok</span><span class="o">=</span><span class="n">overwrite</span>
                <span class="p">)</span>
                <span class="n">save_fn</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># cleanup</span>
            <span class="k">del</span> <span class="n">data</span>

        <span class="n">gens</span><span class="p">,</span> <span class="n">n_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generators_ncalls</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">generators_eager</span><span class="p">(</span><span class="n">gens</span><span class="p">,</span> <span class="n">n_calls</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disable_tqdm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">tree_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">seed</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">pickle_save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_eager_gen</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batchsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">types</span><span class="o">.</span><span class="n">BatchedGenerator</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">batchsize</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eager_gen_from_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eager_gen_from_list</span><span class="p">(</span>
        <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">tree_utils</span><span class="o">.</span><span class="n">PyTree</span><span class="p">],</span>
        <span class="n">batchsize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">types</span><span class="o">.</span><span class="n">BatchedGenerator</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">n_batches</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="n">batchsize</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">shuffle</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batchsize</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batchsize</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">tree_batch</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pytree_deepcopy</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_batches</span>
            <span class="k">return</span> <span class="n">batch</span>

        <span class="k">return</span> <span class="n">generator</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h5 id="src.ring.algorithms.generator.base.RCMG.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">jcalc</span><span class="o">.</span><span class="n">MotionConfig</span><span class="p">(),</span> <span class="n">setup_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">finalize_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_X_imus</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_X_imus_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">add_X_jointaxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_X_jointaxes_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">add_y_relpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_y_rootincl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_y_rootincl_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">add_y_rootfull</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_y_rootfull_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">sys_ml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">randomize_positions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">randomize_motion_artifacts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">randomize_joint_params</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">randomize_hz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">randomize_hz_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">imu_motion_artifacts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imu_motion_artifacts_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">dynamic_simulation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dynamic_simulation_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">output_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_output_extras</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_link_number_in_Xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disable_tqdm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#src.ring.algorithms.generator.base.RCMG.__init__" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Random Chain Motion Generator</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/algorithms/generator/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">sys</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">System</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">jcalc</span><span class="o">.</span><span class="n">MotionConfig</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">jcalc</span><span class="o">.</span><span class="n">MotionConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">jcalc</span><span class="o">.</span><span class="n">MotionConfig</span><span class="p">(),</span>
    <span class="n">setup_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">SETUP_FN</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">finalize_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FINALIZE_FN</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_X_imus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_X_imus_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">add_X_jointaxes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_X_jointaxes_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">add_y_relpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_y_rootincl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_y_rootincl_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">add_y_rootfull</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_y_rootfull_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">sys_ml</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">randomize_positions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">randomize_motion_artifacts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">randomize_joint_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">randomize_hz</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">randomize_hz_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">imu_motion_artifacts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">imu_motion_artifacts_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">dynamic_simulation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dynamic_simulation_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">output_transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_output_extras</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_link_number_in_Xy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">disable_tqdm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="s2">&quot;Random Chain Motion Generator&quot;</span>

    <span class="c1"># add some default values</span>
    <span class="n">randomize_hz_kwargs_defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">add_dt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">randomize_hz_kwargs_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">randomize_hz_kwargs</span><span class="p">)</span>
    <span class="n">randomize_hz_kwargs</span> <span class="o">=</span> <span class="n">randomize_hz_kwargs_defaults</span>

    <span class="n">sys</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">sys</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">sys_ml</span> <span class="o">=</span> <span class="n">sys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">sys_ml</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sys_ml</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">gens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_sys</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">_build_mconfig_batched_generator</span><span class="p">(</span>
                <span class="n">sys</span><span class="o">=</span><span class="n">_sys</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">setup_fn</span><span class="o">=</span><span class="n">setup_fn</span><span class="p">,</span>
                <span class="n">finalize_fn</span><span class="o">=</span><span class="n">finalize_fn</span><span class="p">,</span>
                <span class="n">add_X_imus</span><span class="o">=</span><span class="n">add_X_imus</span><span class="p">,</span>
                <span class="n">add_X_imus_kwargs</span><span class="o">=</span><span class="n">add_X_imus_kwargs</span><span class="p">,</span>
                <span class="n">add_X_jointaxes</span><span class="o">=</span><span class="n">add_X_jointaxes</span><span class="p">,</span>
                <span class="n">add_X_jointaxes_kwargs</span><span class="o">=</span><span class="n">add_X_jointaxes_kwargs</span><span class="p">,</span>
                <span class="n">add_y_relpose</span><span class="o">=</span><span class="n">add_y_relpose</span><span class="p">,</span>
                <span class="n">add_y_rootincl</span><span class="o">=</span><span class="n">add_y_rootincl</span><span class="p">,</span>
                <span class="n">add_y_rootincl_kwargs</span><span class="o">=</span><span class="n">add_y_rootincl_kwargs</span><span class="p">,</span>
                <span class="n">add_y_rootfull</span><span class="o">=</span><span class="n">add_y_rootfull</span><span class="p">,</span>
                <span class="n">add_y_rootfull_kwargs</span><span class="o">=</span><span class="n">add_y_rootfull_kwargs</span><span class="p">,</span>
                <span class="n">sys_ml</span><span class="o">=</span><span class="n">sys_ml</span><span class="p">,</span>
                <span class="n">randomize_positions</span><span class="o">=</span><span class="n">randomize_positions</span><span class="p">,</span>
                <span class="n">randomize_motion_artifacts</span><span class="o">=</span><span class="n">randomize_motion_artifacts</span><span class="p">,</span>
                <span class="n">randomize_joint_params</span><span class="o">=</span><span class="n">randomize_joint_params</span><span class="p">,</span>
                <span class="n">randomize_hz</span><span class="o">=</span><span class="n">randomize_hz</span><span class="p">,</span>
                <span class="n">randomize_hz_kwargs</span><span class="o">=</span><span class="n">randomize_hz_kwargs</span><span class="p">,</span>
                <span class="n">imu_motion_artifacts</span><span class="o">=</span><span class="n">imu_motion_artifacts</span><span class="p">,</span>
                <span class="n">imu_motion_artifacts_kwargs</span><span class="o">=</span><span class="n">imu_motion_artifacts_kwargs</span><span class="p">,</span>
                <span class="n">dynamic_simulation</span><span class="o">=</span><span class="n">dynamic_simulation</span><span class="p">,</span>
                <span class="n">dynamic_simulation_kwargs</span><span class="o">=</span><span class="n">dynamic_simulation_kwargs</span><span class="p">,</span>
                <span class="n">output_transform</span><span class="o">=</span><span class="n">output_transform</span><span class="p">,</span>
                <span class="n">keep_output_extras</span><span class="o">=</span><span class="n">keep_output_extras</span><span class="p">,</span>
                <span class="n">use_link_number_in_Xy</span><span class="o">=</span><span class="n">use_link_number_in_Xy</span><span class="p">,</span>
                <span class="n">cor</span><span class="o">=</span><span class="n">cor</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_n_mconfigs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_size_of_generators</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_mconfigs</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_disable_tqdm</span> <span class="o">=</span> <span class="n">disable_tqdm</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.algorithms.generator.base.RCMG.to_list" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">to_list</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#src.ring.algorithms.generator.base.RCMG.to_list" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Returns list of unbatched sequences as numpy arrays.</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/algorithms/generator/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">tree_utils</span><span class="o">.</span><span class="n">PyTree</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
    <span class="s2">&quot;Returns list of unbatched sequences as numpy arrays.&quot;</span>
    <span class="n">gens</span><span class="p">,</span> <span class="n">n_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generators_ncalls</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">generators_eager</span><span class="p">(</span>
        <span class="n">gens</span><span class="p">,</span> <span class="n">n_calls</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disable_tqdm</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div><h3 id="system">System<a class="headerlink" href="#system" title="Permanent link">¤</a></h3>


<div class="doc doc-object doc-class">



<h4 id="src.ring.base.System" class="doc doc-heading">
          <code>System</code>


<a href="#src.ring.base.System" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">

  
      <p>System object. Create using <code>System.create(path_xml)</code></p>

            <details class="quote">
              <summary>Source code in <code>src/ring/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@struct</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">System</span><span class="p">(</span><span class="n">_Base</span><span class="p">):</span>
    <span class="s2">&quot;System object. Create using `System.create(path_xml)`&quot;</span>
    <span class="n">link_parents</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">links</span><span class="p">:</span> <span class="n">Link</span>
    <span class="n">link_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">link_damping</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">link_armature</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">link_spring_stiffness</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">link_spring_zeropoint</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
    <span class="c1"># simulation timestep size</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># geometries in the system</span>
    <span class="n">geoms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Geometry</span><span class="p">]</span>
    <span class="c1"># root / base acceleration offset</span>
    <span class="n">gravity</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">]))</span>

    <span class="n">integration_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;semi_implicit_euler&quot;</span>
    <span class="p">)</span>
    <span class="n">mass_mat_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">link_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])</span>

    <span class="n">model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">omc</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">MaxCoordOMC</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">num_links</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_parents</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">q_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">Q_WIDTHS</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_types</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">qd_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">QD_WIDTHS</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_types</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">idx_to_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">allow_world</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">allow_world</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;world&quot;</span>
        <span class="k">assert</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Worldbody index has no name.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">idx_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="s2">&quot;type: is either `l` or `q` or `d`&quot;</span>
        <span class="n">dict_int_slices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">idx_map</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">dict_int_slices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_map</span><span class="p">[</span><span class="nb">type</span><span class="p">](</span><span class="n">link_idx</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;ll&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_links</span><span class="p">())))</span>

        <span class="k">return</span> <span class="n">dict_int_slices</span>

    <span class="k">def</span> <span class="nf">parent_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_parents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">name</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">add_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;System&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">link_names</span><span class="o">=</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">change_model_name</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">new_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;System&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">new_name</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">change_link_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;System&quot;</span><span class="p">:</span>
        <span class="n">old_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
        <span class="n">new_link_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_link_names</span><span class="p">[</span><span class="n">old_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">link_names</span><span class="o">=</span><span class="n">new_link_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_prefix_suffix</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;System&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">new_link_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">link_names</span><span class="o">=</span><span class="n">new_link_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_replace_free_with_cor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;System&quot;</span><span class="p">:</span>
        <span class="c1"># check that</span>
        <span class="c1"># - all free joints connect to -1</span>
        <span class="c1"># - all joints connecting to -1 are free joints</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_parents</span><span class="p">):</span>
            <span class="n">link_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">link_type</span> <span class="o">!=</span> <span class="s2">&quot;free&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">link_type</span> <span class="o">==</span> <span class="s2">&quot;free&quot;</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidSystemError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;link=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">, parent=&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">allow_world</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; joint=</span><span class="si">{</span><span class="n">link_type</span><span class="si">}</span><span class="s2">. Hint: Try setting `config.cor` to false.&quot;</span>
                <span class="p">)</span>

        <span class="k">def</span> <span class="nf">logic_replace_free_with_cor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">olt</span><span class="p">,</span> <span class="n">ola</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">ols</span><span class="p">,</span> <span class="n">olz</span><span class="p">):</span>
            <span class="c1"># by default new is equal to old</span>
            <span class="n">nlt</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">nld</span><span class="p">,</span> <span class="n">nls</span><span class="p">,</span> <span class="n">nlz</span> <span class="o">=</span> <span class="n">olt</span><span class="p">,</span> <span class="n">ola</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">ols</span><span class="p">,</span> <span class="n">olz</span>

            <span class="c1"># old link type == free</span>
            <span class="k">if</span> <span class="n">olt</span> <span class="o">==</span> <span class="s2">&quot;free&quot;</span><span class="p">:</span>
                <span class="c1"># cor joint is (free, p3d) stacked</span>
                <span class="n">nlt</span> <span class="o">=</span> <span class="s2">&quot;cor&quot;</span>
                <span class="c1"># entries of old armature are 3*ang (spherical), 3*pos (p3d)</span>
                <span class="n">nla</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ola</span><span class="p">,</span> <span class="n">ola</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                <span class="n">nld</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">old</span><span class="p">,</span> <span class="n">old</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                <span class="n">nls</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ols</span><span class="p">,</span> <span class="n">ols</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                <span class="n">nlz</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">olz</span><span class="p">,</span> <span class="n">olz</span><span class="p">[</span><span class="mi">4</span><span class="p">:]))</span>

            <span class="k">return</span> <span class="n">nlt</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">nld</span><span class="p">,</span> <span class="n">nls</span><span class="p">,</span> <span class="n">nlz</span>

        <span class="k">return</span> <span class="n">_update_sys_if_replace_joint_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logic_replace_free_with_cor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sys</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">sys</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sys</span>

        <span class="k">def</span> <span class="nf">logic_freeze</span><span class="p">(</span><span class="n">link_name</span><span class="p">,</span> <span class="n">olt</span><span class="p">,</span> <span class="n">ola</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">ols</span><span class="p">,</span> <span class="n">olz</span><span class="p">):</span>
            <span class="n">nlt</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">nld</span><span class="p">,</span> <span class="n">nls</span><span class="p">,</span> <span class="n">nlz</span> <span class="o">=</span> <span class="n">olt</span><span class="p">,</span> <span class="n">ola</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">ols</span><span class="p">,</span> <span class="n">olz</span>

            <span class="k">if</span> <span class="n">link_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">nlt</span> <span class="o">=</span> <span class="s2">&quot;frozen&quot;</span>
                <span class="n">nla</span> <span class="o">=</span> <span class="n">nld</span> <span class="o">=</span> <span class="n">nls</span> <span class="o">=</span> <span class="n">nlz</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

            <span class="k">return</span> <span class="n">nlt</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">nld</span><span class="p">,</span> <span class="n">nls</span><span class="p">,</span> <span class="n">nlz</span>

        <span class="k">return</span> <span class="n">_update_sys_if_replace_joint_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logic_freeze</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unfreeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_joint_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">==</span> <span class="s2">&quot;frozen&quot;</span>
        <span class="k">assert</span> <span class="n">new_joint_type</span> <span class="o">!=</span> <span class="s2">&quot;frozen&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_joint_type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">new_joint_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">change_joint_type</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new_joint_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new_arma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">new_damp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">new_stif</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">new_zero</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">warn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="s2">&quot;By default damping, stiffness are set to zero.&quot;</span>
        <span class="kn">from</span> <span class="nn">ring.algorithms</span> <span class="kn">import</span> <span class="n">get_joint_model</span>

        <span class="n">q_size</span><span class="p">,</span> <span class="n">qd_size</span> <span class="o">=</span> <span class="n">Q_WIDTHS</span><span class="p">[</span><span class="n">new_joint_type</span><span class="p">],</span> <span class="n">QD_WIDTHS</span><span class="p">[</span><span class="n">new_joint_type</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">logic_unfreeze_to_spherical</span><span class="p">(</span><span class="n">link_name</span><span class="p">,</span> <span class="n">olt</span><span class="p">,</span> <span class="n">ola</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">ols</span><span class="p">,</span> <span class="n">olz</span><span class="p">):</span>
            <span class="n">nlt</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">nld</span><span class="p">,</span> <span class="n">nls</span><span class="p">,</span> <span class="n">nlz</span> <span class="o">=</span> <span class="n">olt</span><span class="p">,</span> <span class="n">ola</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">ols</span><span class="p">,</span> <span class="n">olz</span>

            <span class="k">if</span> <span class="n">link_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">nlt</span> <span class="o">=</span> <span class="n">new_joint_type</span>
                <span class="n">q_zeros</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">q_size</span><span class="p">))</span>
                <span class="n">qd_zeros</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">qd_size</span><span class="p">,))</span>

                <span class="n">nla</span> <span class="o">=</span> <span class="n">qd_zeros</span> <span class="k">if</span> <span class="n">new_arma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_arma</span>
                <span class="n">nld</span> <span class="o">=</span> <span class="n">qd_zeros</span> <span class="k">if</span> <span class="n">new_damp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_damp</span>
                <span class="n">nls</span> <span class="o">=</span> <span class="n">qd_zeros</span> <span class="k">if</span> <span class="n">new_stif</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_stif</span>
                <span class="n">nlz</span> <span class="o">=</span> <span class="n">q_zeros</span> <span class="k">if</span> <span class="n">new_zero</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_zero</span>

                <span class="c1"># unit quaternion</span>
                <span class="k">if</span> <span class="n">new_joint_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;spherical&quot;</span><span class="p">,</span> <span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="s2">&quot;cor&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">new_zero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">nlz</span> <span class="o">=</span> <span class="n">nlz</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">nlt</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">nld</span><span class="p">,</span> <span class="n">nls</span><span class="p">,</span> <span class="n">nlz</span>

        <span class="n">sys</span> <span class="o">=</span> <span class="n">_update_sys_if_replace_joint_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logic_unfreeze_to_spherical</span><span class="p">)</span>

        <span class="n">jm</span> <span class="o">=</span> <span class="n">get_joint_model</span><span class="p">(</span><span class="n">new_joint_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jm</span><span class="o">.</span><span class="n">init_joint_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sys</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">joint_type_simplification</span><span class="p">(</span><span class="n">typ</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">typ</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;free&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;free_2d&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;free_2d&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;free&quot;</span>
        <span class="k">elif</span> <span class="n">typ</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cor&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;cor&quot;</span>
        <span class="k">elif</span> <span class="n">typ</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spherical&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;spherical&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">typ</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">joint_type_is_free_or_cor</span><span class="p">(</span><span class="n">typ</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="n">joint_type_simplification</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="s2">&quot;cor&quot;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">joint_type_is_spherical</span><span class="p">(</span><span class="n">typ</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="n">joint_type_simplification</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;spherical&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">joint_type_is_free_or_cor_or_spherical</span><span class="p">(</span><span class="n">typ</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="n">joint_type_is_free_or_cor</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="ow">or</span> <span class="n">System</span><span class="o">.</span><span class="n">joint_type_is_spherical</span><span class="p">(</span>
            <span class="n">typ</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">findall_imus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span> <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;imu&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">bodies</span> <span class="k">if</span> <span class="n">names</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">findall_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">imus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findall_imus</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">imus</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">bodies</span> <span class="k">if</span> <span class="n">names</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_bodies_indices_to_bodies_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bodies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">findall_bodies_to_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_parents</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bodies_indices_to_bodies_name</span><span class="p">(</span><span class="n">bodies</span><span class="p">)</span> <span class="k">if</span> <span class="n">names</span> <span class="k">else</span> <span class="n">bodies</span>

    <span class="k">def</span> <span class="nf">find_body_to_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findall_bodies_to_world</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bodies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">bodies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">findall_bodies_with_jointtype</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_typ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_types</span><span class="p">)</span> <span class="k">if</span> <span class="n">_typ</span> <span class="o">==</span> <span class="n">typ</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bodies_indices_to_bodies_name</span><span class="p">(</span><span class="n">bodies</span><span class="p">)</span> <span class="k">if</span> <span class="n">names</span> <span class="k">else</span> <span class="n">bodies</span>

    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="s2">&quot;List all direct children of body, does not include body itself&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_links</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">bodies</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">names</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">findall_bodies_subsystem</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="s2">&quot;List all children and children&#39;s children; does not include body itself&quot;</span>
        <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">grandchildren</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">findall_bodies_subsystem</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">children</span><span class="p">,</span> <span class="n">grandchildren</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">bodies</span> <span class="k">if</span> <span class="n">names</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">in_types</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scan `f` along each link in system whilst carrying along state.</span>

<span class="sd">        Args:</span>
<span class="sd">            f (Callable[..., Y]): f(y: Y, *args) -&gt; y</span>
<span class="sd">            in_types: string specifying the type of each input arg:</span>
<span class="sd">                &#39;l&#39; is an input to be split according to link ranges</span>
<span class="sd">                &#39;q&#39; is an input to be split according to q ranges</span>
<span class="sd">                &#39;d&#39; is an input to be split according to qd ranges</span>
<span class="sd">            args: Arguments passed to `f`, and split to match the link.</span>
<span class="sd">            reverse (bool, optional): If `true` from leaves to root. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ys: Stacked output y of f.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_scan_sys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">in_types</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;System&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initial setup of system. System object does not work unless it is parsed.</span>
<span class="sd">        Currently it does:</span>
<span class="sd">        - some consistency checks</span>
<span class="sd">        - populate the spatial inertia tensors</span>
<span class="sd">        - check that all names are unique</span>
<span class="sd">        - check that names are strings</span>
<span class="sd">        - check that all pos_min &lt;= pos_max (unless traced)</span>
<span class="sd">        - order geoms in ascending order based on their parent link idx</span>
<span class="sd">        - check that all links have the correct size of</span>
<span class="sd">            - damping</span>
<span class="sd">            - armature</span>
<span class="sd">            - stiffness</span>
<span class="sd">            - zeropoint</span>
<span class="sd">        - check that n_links == len(sys.omc)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_parse_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">xs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Transform</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Transform</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">camera</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_pbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mujoco&quot;</span><span class="p">,</span>
        <span class="n">render_every_nth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">scene_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render frames from system and trajectory of maximal coordinates `xs`.</span>

<span class="sd">        Args:</span>
<span class="sd">            sys (base.System): System to render.</span>
<span class="sd">            xs (base.Transform | list[base.Transform]): Single or time-series</span>
<span class="sd">            of maximal coordinates `xs`.</span>
<span class="sd">            show_pbar (bool, optional): Whether or not to show a progress bar.</span>
<span class="sd">            Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[np.ndarray]: Stacked rendered frames. Length == len(xs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">rendering</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="n">show_pbar</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">render_every_nth</span><span class="p">,</span> <span class="o">**</span><span class="n">scene_kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">xs</span><span class="p">:</span> <span class="n">Transform</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Transform</span><span class="p">],</span>
        <span class="n">yhat</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="c1"># by default we don&#39;t predict the global rotation</span>
        <span class="n">transparent_segment_to_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`xs` matches `sys`. `yhat` matches `sys_noimu`. `yhat` are child-to-parent.</span>
<span class="sd">        Note that the body in yhat that connects to -1, is parent-to-child!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">rendering</span><span class="o">.</span><span class="n">render_prediction</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">transparent_segment_to_root</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="s2">&quot;Cut subsystem starting at `link_name` (inclusive) from tree.&quot;</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">sys_composer</span><span class="o">.</span><span class="n">delete_subsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link_name</span><span class="p">,</span> <span class="n">strict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_sys_noimu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imu_link_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Returns, e.g., imu_attachment = {&#39;imu1&#39;: &#39;seg1&#39;, &#39;imu2&#39;: &#39;seg3&#39;}&quot;</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">sys_composer</span><span class="o">.</span><span class="n">make_sys_noimu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imu_link_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inject_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_system</span><span class="p">:</span> <span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="n">at_body</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine two systems into one.</span>

<span class="sd">        Args:</span>
<span class="sd">            sys (base.System): Large system.</span>
<span class="sd">            sub_sys (base.System): Small system that will be included into the</span>
<span class="sd">                large system `sys`.</span>
<span class="sd">            at_body (Optional[str], optional): Into which body of the large system</span>
<span class="sd">                small system will be included. Defaults to `worldbody`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            base.System: _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">sys_composer</span><span class="o">.</span><span class="n">inject_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_system</span><span class="p">,</span> <span class="n">at_body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">morph_system</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">new_parents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">new_anchor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Re-orders the graph underlying the system. Returns a new system.</span>

<span class="sd">        Args:</span>
<span class="sd">            sys (base.System): System to be modified.</span>
<span class="sd">            new_parents (list[int]): Let the i-th entry have value j. Then, after</span>
<span class="sd">                morphing the system the system will be such that the link corresponding</span>
<span class="sd">                to the i-th link in the old system will have as parent the link</span>
<span class="sd">                corresponding to the j-th link in the old system.</span>

<span class="sd">        Returns:</span>
<span class="sd">            base.System: Modified system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">sys_composer</span><span class="o">.</span><span class="n">morph_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_parents</span><span class="p">,</span> <span class="n">new_anchor</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_xml</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_sys_from_xml</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_str</span><span class="p">(</span><span class="n">xml</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_sys_from_str</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save_sys_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ring</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save_sys_to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path_or_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;System&quot;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_or_str</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span>

        <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># file length too length</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_xml</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">path_or_str</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">coordinate_vector_to_q</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
        <span class="n">custom_joints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map a coordinate vector `q` to the minimal coordinates vector of the sys&quot;&quot;&quot;</span>
        <span class="c1"># Does, e.g.</span>
        <span class="c1"># - normalize quaternions</span>
        <span class="c1"># - hinge joints in [-pi, pi]</span>
        <span class="n">q_preproc</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
            <span class="n">to_q</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">jcalc</span><span class="o">.</span><span class="n">get_joint_model</span><span class="p">(</span>
                <span class="n">link_type</span>
            <span class="p">)</span><span class="o">.</span><span class="n">coordinate_vector_to_q</span>
            <span class="c1"># function in custom_joints has priority over JointModel</span>
            <span class="k">if</span> <span class="n">link_type</span> <span class="ow">in</span> <span class="n">custom_joints</span><span class="p">:</span>
                <span class="n">to_q</span> <span class="o">=</span> <span class="n">custom_joints</span><span class="p">[</span><span class="n">link_type</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">to_q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Please specify the custom joint `</span><span class="si">{</span><span class="n">link_type</span><span class="si">}</span><span class="s2">`&quot;</span>
                    <span class="s2">&quot; either using the `custom_joints` arguments or using the&quot;</span>
                    <span class="s2">&quot; JointModel.coordinate_vector_to_q field.&quot;</span>
                <span class="p">)</span>
            <span class="n">new_q</span> <span class="o">=</span> <span class="n">to_q</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">q_preproc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_q</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">preprocess</span><span class="p">,</span> <span class="s2">&quot;lq&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_types</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">q_preproc</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.idx_map" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">idx_map</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span></code>

<a href="#src.ring.base.System.idx_map" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>type: is either <code>l</code> or <code>q</code> or <code>d</code></p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">idx_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="s2">&quot;type: is either `l` or `q` or `d`&quot;</span>
    <span class="n">dict_int_slices</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">idx_map</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">dict_int_slices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_map</span><span class="p">[</span><span class="nb">type</span><span class="p">](</span><span class="n">link_idx</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;ll&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_links</span><span class="p">())))</span>

    <span class="k">return</span> <span class="n">dict_int_slices</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.change_joint_type" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">change_joint_type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">new_joint_type</span><span class="p">,</span> <span class="n">new_arma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_damp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_stif</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#src.ring.base.System.change_joint_type" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>By default damping, stiffness are set to zero.</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">change_joint_type</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">new_joint_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">new_arma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">new_damp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">new_stif</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">new_zero</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">warn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="s2">&quot;By default damping, stiffness are set to zero.&quot;</span>
    <span class="kn">from</span> <span class="nn">ring.algorithms</span> <span class="kn">import</span> <span class="n">get_joint_model</span>

    <span class="n">q_size</span><span class="p">,</span> <span class="n">qd_size</span> <span class="o">=</span> <span class="n">Q_WIDTHS</span><span class="p">[</span><span class="n">new_joint_type</span><span class="p">],</span> <span class="n">QD_WIDTHS</span><span class="p">[</span><span class="n">new_joint_type</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">logic_unfreeze_to_spherical</span><span class="p">(</span><span class="n">link_name</span><span class="p">,</span> <span class="n">olt</span><span class="p">,</span> <span class="n">ola</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">ols</span><span class="p">,</span> <span class="n">olz</span><span class="p">):</span>
        <span class="n">nlt</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">nld</span><span class="p">,</span> <span class="n">nls</span><span class="p">,</span> <span class="n">nlz</span> <span class="o">=</span> <span class="n">olt</span><span class="p">,</span> <span class="n">ola</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">ols</span><span class="p">,</span> <span class="n">olz</span>

        <span class="k">if</span> <span class="n">link_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">nlt</span> <span class="o">=</span> <span class="n">new_joint_type</span>
            <span class="n">q_zeros</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">q_size</span><span class="p">))</span>
            <span class="n">qd_zeros</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">qd_size</span><span class="p">,))</span>

            <span class="n">nla</span> <span class="o">=</span> <span class="n">qd_zeros</span> <span class="k">if</span> <span class="n">new_arma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_arma</span>
            <span class="n">nld</span> <span class="o">=</span> <span class="n">qd_zeros</span> <span class="k">if</span> <span class="n">new_damp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_damp</span>
            <span class="n">nls</span> <span class="o">=</span> <span class="n">qd_zeros</span> <span class="k">if</span> <span class="n">new_stif</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_stif</span>
            <span class="n">nlz</span> <span class="o">=</span> <span class="n">q_zeros</span> <span class="k">if</span> <span class="n">new_zero</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_zero</span>

            <span class="c1"># unit quaternion</span>
            <span class="k">if</span> <span class="n">new_joint_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;spherical&quot;</span><span class="p">,</span> <span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="s2">&quot;cor&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">new_zero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nlz</span> <span class="o">=</span> <span class="n">nlz</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nlt</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">nld</span><span class="p">,</span> <span class="n">nls</span><span class="p">,</span> <span class="n">nlz</span>

    <span class="n">sys</span> <span class="o">=</span> <span class="n">_update_sys_if_replace_joint_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logic_unfreeze_to_spherical</span><span class="p">)</span>

    <span class="n">jm</span> <span class="o">=</span> <span class="n">get_joint_model</span><span class="p">(</span><span class="n">new_joint_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jm</span><span class="o">.</span><span class="n">init_joint_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sys</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sys</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.children" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">children</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#src.ring.base.System.children" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>List all direct children of body, does not include body itself</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="s2">&quot;List all direct children of body, does not include body itself&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_links</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bodies</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">names</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.findall_bodies_subsystem" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">findall_bodies_subsystem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#src.ring.base.System.findall_bodies_subsystem" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>List all children and children's children; does not include body itself</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">findall_bodies_subsystem</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="s2">&quot;List all children and children&#39;s children; does not include body itself&quot;</span>
    <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grandchildren</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">findall_bodies_subsystem</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
    <span class="n">bodies</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">children</span><span class="p">,</span> <span class="n">grandchildren</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">bodies</span> <span class="k">if</span> <span class="n">names</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.scan" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">scan</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">in_types</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#src.ring.base.System.scan" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Scan <code>f</code> along each link in system whilst carrying along state.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>f</code></b>
                  (<code><span title="typing.Callable">Callable</span>[..., Y]</code>)
              –
              <div class="doc-md-description">
                <p>f(y: Y, *args) -&gt; y</p>
              </div>
            </li>
            <li>
              <b><code>in_types</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>string specifying the type of each input arg:
'l' is an input to be split according to link ranges
'q' is an input to be split according to q ranges
'd' is an input to be split according to qd ranges</p>
              </div>
            </li>
            <li>
              <b><code>args</code></b>
              –
              <div class="doc-md-description">
                <p>Arguments passed to <code>f</code>, and split to match the link.</p>
              </div>
            </li>
            <li>
              <b><code>reverse</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>If <code>true</code> from leaves to root. Defaults to False.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b><code>ys</code></b>            –
            <div class="doc-md-description">
              <p>Stacked output y of f.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">in_types</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scan `f` along each link in system whilst carrying along state.</span>

<span class="sd">    Args:</span>
<span class="sd">        f (Callable[..., Y]): f(y: Y, *args) -&gt; y</span>
<span class="sd">        in_types: string specifying the type of each input arg:</span>
<span class="sd">            &#39;l&#39; is an input to be split according to link ranges</span>
<span class="sd">            &#39;q&#39; is an input to be split according to q ranges</span>
<span class="sd">            &#39;d&#39; is an input to be split according to qd ranges</span>
<span class="sd">        args: Arguments passed to `f`, and split to match the link.</span>
<span class="sd">        reverse (bool, optional): If `true` from leaves to root. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ys: Stacked output y of f.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_scan_sys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">in_types</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.parse" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">parse</span><span class="p">()</span></code>

<a href="#src.ring.base.System.parse" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Initial setup of system. System object does not work unless it is parsed.
Currently it does:
- some consistency checks
- populate the spatial inertia tensors
- check that all names are unique
- check that names are strings
- check that all pos_min &lt;= pos_max (unless traced)
- order geoms in ascending order based on their parent link idx
- check that all links have the correct size of
    - damping
    - armature
    - stiffness
    - zeropoint
- check that n_links == len(sys.omc)</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;System&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initial setup of system. System object does not work unless it is parsed.</span>
<span class="sd">    Currently it does:</span>
<span class="sd">    - some consistency checks</span>
<span class="sd">    - populate the spatial inertia tensors</span>
<span class="sd">    - check that all names are unique</span>
<span class="sd">    - check that names are strings</span>
<span class="sd">    - check that all pos_min &lt;= pos_max (unless traced)</span>
<span class="sd">    - order geoms in ascending order based on their parent link idx</span>
<span class="sd">    - check that all links have the correct size of</span>
<span class="sd">        - damping</span>
<span class="sd">        - armature</span>
<span class="sd">        - stiffness</span>
<span class="sd">        - zeropoint</span>
<span class="sd">    - check that n_links == len(sys.omc)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_parse_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.render" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">render</span><span class="p">(</span><span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">camera</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_pbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;mujoco&#39;</span><span class="p">,</span> <span class="n">render_every_nth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">scene_kwargs</span><span class="p">)</span></code>

<a href="#src.ring.base.System.render" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Render frames from system and trajectory of maximal coordinates <code>xs</code>.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>sys</code></b>
                  (<code><a class="autorefs autorefs-internal" title="src.ring.base.System" href="#src.ring.base.System">System</a></code>)
              –
              <div class="doc-md-description">
                <p>System to render.</p>
              </div>
            </li>
            <li>
              <b><code>xs</code></b>
                  (<code><a class="autorefs autorefs-internal" title="src.ring.base.Transform" href="#src.ring.base.Transform">Transform</a> | list[<a class="autorefs autorefs-internal" title="src.ring.base.Transform" href="#src.ring.base.Transform">Transform</a>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Single or time-series</p>
              </div>
            </li>
            <li>
              <b><code>show_pbar</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether or not to show a progress bar.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>list[<span title="numpy.ndarray">ndarray</span>]</code>
            –
            <div class="doc-md-description">
              <p>list[np.ndarray]: Stacked rendered frames. Length == len(xs).</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">xs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Transform</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Transform</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">camera</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">show_pbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mujoco&quot;</span><span class="p">,</span>
    <span class="n">render_every_nth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">scene_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render frames from system and trajectory of maximal coordinates `xs`.</span>

<span class="sd">    Args:</span>
<span class="sd">        sys (base.System): System to render.</span>
<span class="sd">        xs (base.Transform | list[base.Transform]): Single or time-series</span>
<span class="sd">        of maximal coordinates `xs`.</span>
<span class="sd">        show_pbar (bool, optional): Whether or not to show a progress bar.</span>
<span class="sd">        Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[np.ndarray]: Stacked rendered frames. Length == len(xs).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">rendering</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="n">show_pbar</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">render_every_nth</span><span class="p">,</span> <span class="o">**</span><span class="n">scene_kwargs</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.render_prediction" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">render_prediction</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">transparent_segment_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#src.ring.base.System.render_prediction" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p><code>xs</code> matches <code>sys</code>. <code>yhat</code> matches <code>sys_noimu</code>. <code>yhat</code> are child-to-parent.
Note that the body in yhat that connects to -1, is parent-to-child!</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">render_prediction</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">xs</span><span class="p">:</span> <span class="n">Transform</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Transform</span><span class="p">],</span>
    <span class="n">yhat</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="c1"># by default we don&#39;t predict the global rotation</span>
    <span class="n">transparent_segment_to_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;`xs` matches `sys`. `yhat` matches `sys_noimu`. `yhat` are child-to-parent.</span>
<span class="sd">    Note that the body in yhat that connects to -1, is parent-to-child!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">rendering</span><span class="o">.</span><span class="n">render_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">transparent_segment_to_root</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.delete_system" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">delete_system</span><span class="p">(</span><span class="n">link_name</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#src.ring.base.System.delete_system" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Cut subsystem starting at <code>link_name</code> (inclusive) from tree.</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delete_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="s2">&quot;Cut subsystem starting at `link_name` (inclusive) from tree.&quot;</span>
    <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">sys_composer</span><span class="o">.</span><span class="n">delete_subsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link_name</span><span class="p">,</span> <span class="n">strict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.make_sys_noimu" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">make_sys_noimu</span><span class="p">(</span><span class="n">imu_link_names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.ring.base.System.make_sys_noimu" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Returns, e.g., imu_attachment = {'imu1': 'seg1', 'imu2': 'seg3'}</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_sys_noimu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imu_link_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Returns, e.g., imu_attachment = {&#39;imu1&#39;: &#39;seg1&#39;, &#39;imu2&#39;: &#39;seg3&#39;}&quot;</span>
    <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">sys_composer</span><span class="o">.</span><span class="n">make_sys_noimu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imu_link_names</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.inject_system" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">inject_system</span><span class="p">(</span><span class="n">other_system</span><span class="p">,</span> <span class="n">at_body</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.ring.base.System.inject_system" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Combine two systems into one.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>sys</code></b>
                  (<code><a class="autorefs autorefs-internal" title="src.ring.base.System" href="#src.ring.base.System">System</a></code>)
              –
              <div class="doc-md-description">
                <p>Large system.</p>
              </div>
            </li>
            <li>
              <b><code>sub_sys</code></b>
                  (<code><a class="autorefs autorefs-internal" title="src.ring.base.System" href="#src.ring.base.System">System</a></code>)
              –
              <div class="doc-md-description">
                <p>Small system that will be included into the
large system <code>sys</code>.</p>
              </div>
            </li>
            <li>
              <b><code>at_body</code></b>
                  (<code><span title="typing.Optional">Optional</span>[str]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Into which body of the large system
small system will be included. Defaults to <code>worldbody</code>.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
            –
            <div class="doc-md-description">
              <p>base.System: <em>description</em></p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">inject_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_system</span><span class="p">:</span> <span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="n">at_body</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine two systems into one.</span>

<span class="sd">    Args:</span>
<span class="sd">        sys (base.System): Large system.</span>
<span class="sd">        sub_sys (base.System): Small system that will be included into the</span>
<span class="sd">            large system `sys`.</span>
<span class="sd">        at_body (Optional[str], optional): Into which body of the large system</span>
<span class="sd">            small system will be included. Defaults to `worldbody`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        base.System: _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">sys_composer</span><span class="o">.</span><span class="n">inject_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_system</span><span class="p">,</span> <span class="n">at_body</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.morph_system" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">morph_system</span><span class="p">(</span><span class="n">new_parents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_anchor</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.ring.base.System.morph_system" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Re-orders the graph underlying the system. Returns a new system.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>sys</code></b>
                  (<code><a class="autorefs autorefs-internal" title="src.ring.base.System" href="#src.ring.base.System">System</a></code>)
              –
              <div class="doc-md-description">
                <p>System to be modified.</p>
              </div>
            </li>
            <li>
              <b><code>new_parents</code></b>
                  (<code>list[int]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Let the i-th entry have value j. Then, after
morphing the system the system will be such that the link corresponding
to the i-th link in the old system will have as parent the link
corresponding to the j-th link in the old system.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
            –
            <div class="doc-md-description">
              <p>base.System: Modified system.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">morph_system</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">new_parents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">new_anchor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Re-orders the graph underlying the system. Returns a new system.</span>

<span class="sd">    Args:</span>
<span class="sd">        sys (base.System): System to be modified.</span>
<span class="sd">        new_parents (list[int]): Let the i-th entry have value j. Then, after</span>
<span class="sd">            morphing the system the system will be such that the link corresponding</span>
<span class="sd">            to the i-th link in the old system will have as parent the link</span>
<span class="sd">            corresponding to the j-th link in the old system.</span>

<span class="sd">    Returns:</span>
<span class="sd">        base.System: Modified system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ring</span><span class="o">.</span><span class="n">sys_composer</span><span class="o">.</span><span class="n">morph_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_parents</span><span class="p">,</span> <span class="n">new_anchor</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.base.System.coordinate_vector_to_q" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">coordinate_vector_to_q</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">custom_joints</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#src.ring.base.System.coordinate_vector_to_q" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Map a coordinate vector <code>q</code> to the minimal coordinates vector of the sys</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">coordinate_vector_to_q</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">q</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">custom_joints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map a coordinate vector `q` to the minimal coordinates vector of the sys&quot;&quot;&quot;</span>
    <span class="c1"># Does, e.g.</span>
    <span class="c1"># - normalize quaternions</span>
    <span class="c1"># - hinge joints in [-pi, pi]</span>
    <span class="n">q_preproc</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="n">to_q</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">jcalc</span><span class="o">.</span><span class="n">get_joint_model</span><span class="p">(</span>
            <span class="n">link_type</span>
        <span class="p">)</span><span class="o">.</span><span class="n">coordinate_vector_to_q</span>
        <span class="c1"># function in custom_joints has priority over JointModel</span>
        <span class="k">if</span> <span class="n">link_type</span> <span class="ow">in</span> <span class="n">custom_joints</span><span class="p">:</span>
            <span class="n">to_q</span> <span class="o">=</span> <span class="n">custom_joints</span><span class="p">[</span><span class="n">link_type</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">to_q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Please specify the custom joint `</span><span class="si">{</span><span class="n">link_type</span><span class="si">}</span><span class="s2">`&quot;</span>
                <span class="s2">&quot; either using the `custom_joints` arguments or using the&quot;</span>
                <span class="s2">&quot; JointModel.coordinate_vector_to_q field.&quot;</span>
            <span class="p">)</span>
        <span class="n">new_q</span> <span class="o">=</span> <span class="n">to_q</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">q_preproc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_q</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">preprocess</span><span class="p">,</span> <span class="s2">&quot;lq&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_types</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">q_preproc</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div><h3 id="motionconfig">MotionConfig<a class="headerlink" href="#motionconfig" title="Permanent link">¤</a></h3>


<div class="doc doc-object doc-class">



<h4 id="src.ring.algorithms.jcalc.MotionConfig" class="doc doc-heading">
          <code>MotionConfig</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#src.ring.algorithms.jcalc.MotionConfig" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">

  
      <p>Configuration for joint motion generation in kinematic and dynamic simulations.</p>
<p>This class defines the constraints and parameters for generating random joint motions,
including angular and positional velocity limits, interpolation methods, and range
restrictions for various joint types.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Attributes:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>T</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Total duration of the motion sequence (in seconds).</p>
              </div>
            </li>
            <li>
              <b><code>t_min</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Minimum time interval between two generated joint states.</p>
              </div>
            </li>
            <li>
              <b><code>t_max</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum time interval between two generated joint states.</p>
              </div>
            </li>
            <li>
              <b><code>dang_min</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum angular velocity (rad/s).</p>
              </div>
            </li>
            <li>
              <b><code>dang_max</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum angular velocity (rad/s).</p>
              </div>
            </li>
            <li>
              <b><code>dang_min_free_spherical</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum angular velocity for free and spherical joints.</p>
              </div>
            </li>
            <li>
              <b><code>dang_max_free_spherical</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum angular velocity for free and spherical joints.</p>
              </div>
            </li>
            <li>
              <b><code>delta_ang_min</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum allowed change in joint angle (radians).</p>
              </div>
            </li>
            <li>
              <b><code>delta_ang_max</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum allowed change in joint angle (radians).</p>
              </div>
            </li>
            <li>
              <b><code>delta_ang_min_free_spherical</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum allowed change in angle for free/spherical joints.</p>
              </div>
            </li>
            <li>
              <b><code>delta_ang_max_free_spherical</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum allowed change in angle for free/spherical joints.</p>
              </div>
            </li>
            <li>
              <b><code>dpos_min</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum translational velocity.</p>
              </div>
            </li>
            <li>
              <b><code>dpos_max</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum translational velocity.</p>
              </div>
            </li>
            <li>
              <b><code>pos_min</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum position constraint.</p>
              </div>
            </li>
            <li>
              <b><code>pos_max</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum position constraint.</p>
              </div>
            </li>
            <li>
              <b><code>pos_min_p3d_x</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum position in x-direction for P3D joints.</p>
              </div>
            </li>
            <li>
              <b><code>pos_max_p3d_x</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum position in x-direction for P3D joints.</p>
              </div>
            </li>
            <li>
              <b><code>pos_min_p3d_y</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum position in y-direction for P3D joints.</p>
              </div>
            </li>
            <li>
              <b><code>pos_max_p3d_y</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum position in y-direction for P3D joints.</p>
              </div>
            </li>
            <li>
              <b><code>pos_min_p3d_z</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum position in z-direction for P3D joints.</p>
              </div>
            </li>
            <li>
              <b><code>pos_max_p3d_z</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum position in z-direction for P3D joints.</p>
              </div>
            </li>
            <li>
              <b><code>cdf_bins_min</code></b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Minimum number of bins for cumulative distribution function (CDF)-based random sampling.</p>
              </div>
            </li>
            <li>
              <b><code>cdf_bins_max</code></b>
                  (<code><span title="typing.Optional">Optional</span>[int]</code>)
              –
              <div class="doc-md-description">
                <p>Maximum number of bins for CDF-based sampling.</p>
              </div>
            </li>
            <li>
              <b><code>randomized_interpolation_angle</code></b>
                  (<code>bool</code>)
              –
              <div class="doc-md-description">
                <p>Whether to use randomized interpolation for angular motion.</p>
              </div>
            </li>
            <li>
              <b><code>randomized_interpolation_position</code></b>
                  (<code>bool</code>)
              –
              <div class="doc-md-description">
                <p>Whether to use randomized interpolation for positional motion.</p>
              </div>
            </li>
            <li>
              <b><code>interpolation_method</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Interpolation method to be used (default: "cosine").</p>
              </div>
            </li>
            <li>
              <b><code>range_of_motion_hinge</code></b>
                  (<code>bool</code>)
              –
              <div class="doc-md-description">
                <p>Whether to enforce range-of-motion constraints on hinge joints.</p>
              </div>
            </li>
            <li>
              <b><code>range_of_motion_hinge_method</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Method used for range-of-motion enforcement (e.g., "uniform", "sigmoid").</p>
              </div>
            </li>
            <li>
              <b><code>rom_halfsize</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Half-size of the range of motion restriction.</p>
              </div>
            </li>
            <li>
              <b><code>ang0_min</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Minimum initial joint angle.</p>
              </div>
            </li>
            <li>
              <b><code>ang0_max</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Maximum initial joint angle.</p>
              </div>
            </li>
            <li>
              <b><code>pos0_min</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Minimum initial joint position.</p>
              </div>
            </li>
            <li>
              <b><code>pos0_max</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Maximum initial joint position.</p>
              </div>
            </li>
            <li>
              <b><code>cor_t_min</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Minimum time step for center-of-rotation (COR) joints.</p>
              </div>
            </li>
            <li>
              <b><code>cor_t_max</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum time step for COR joints.</p>
              </div>
            </li>
            <li>
              <b><code>cor_dpos_min</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum velocity for COR translation.</p>
              </div>
            </li>
            <li>
              <b><code>cor_dpos_max</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum velocity for COR translation.</p>
              </div>
            </li>
            <li>
              <b><code>cor_pos_min</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Minimum position for COR translation.</p>
              </div>
            </li>
            <li>
              <b><code>cor_pos_max</code></b>
                  (<code>float | <span title="ring.algorithms._random.TimeDependentFloat">TimeDependentFloat</span></code>)
              –
              <div class="doc-md-description">
                <p>Maximum position for COR translation.</p>
              </div>
            </li>
            <li>
              <b><code>cor_pos0_min</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Initial minimum position for COR translation.</p>
              </div>
            </li>
            <li>
              <b><code>cor_pos0_max</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Initial maximum position for COR translation.</p>
              </div>
            </li>
            <li>
              <b><code>joint_type_specific_overwrites</code></b>
                  (<code>dict[str, dict[str, <span title="typing.Any">Any</span>]]</code>)
              –
              <div class="doc-md-description">
                <p>A dictionary mapping joint types to specific motion configuration overrides.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


  <p><strong>Methods:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
          <tr>
            <td><code><span title="src.ring.algorithms.jcalc.MotionConfig.is_feasible">is_feasible</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>Checks if the motion configuration satisfies all constraints.</p>
              </div>
            </td>
          </tr>
          <tr>
            <td><code><span title="src.ring.algorithms.jcalc.MotionConfig.to_nomotion_config">to_nomotion_config</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>Returns a new <code>MotionConfig</code> where all velocities and angle changes are set to zero.</p>
              </div>
            </td>
          </tr>
          <tr>
            <td><code><a class="autorefs autorefs-internal" title="src.ring.algorithms.jcalc.MotionConfig.overwrite_for_joint_type" href="#src.ring.algorithms.jcalc.MotionConfig.overwrite_for_joint_type">overwrite_for_joint_type</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>str, **changes) -&gt; None:
Applies specific configuration changes for a given joint type.
Note: These changes affect all instances of <code>MotionConfig</code> for this joint type.</p>
              </div>
            </td>
          </tr>
          <tr>
            <td><code><a class="autorefs autorefs-internal" title="src.ring.algorithms.jcalc.MotionConfig.overwrite_for_subsystem" href="#src.ring.algorithms.jcalc.MotionConfig.overwrite_for_subsystem">overwrite_for_subsystem</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>base.System, link_name: str, **changes) -&gt; base.System:
Modifies the motion configuration for all joints in a subsystem rooted at <code>link_name</code>.</p>
              </div>
            </td>
          </tr>
          <tr>
            <td><code><span title="src.ring.algorithms.jcalc.MotionConfig.from_register">from_register</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>str) -&gt; "MotionConfig":
Retrieves a predefined <code>MotionConfig</code> from the global registry.</p>
              </div>
            </td>
          </tr>
    </tbody>
  </table>

            <details class="quote">
              <summary>Source code in <code>src/ring/algorithms/jcalc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MotionConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration for joint motion generation in kinematic and dynamic simulations.</span>

<span class="sd">    This class defines the constraints and parameters for generating random joint motions,</span>
<span class="sd">    including angular and positional velocity limits, interpolation methods, and range</span>
<span class="sd">    restrictions for various joint types.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        T (float): Total duration of the motion sequence (in seconds).</span>
<span class="sd">        t_min (float): Minimum time interval between two generated joint states.</span>
<span class="sd">        t_max (float | TimeDependentFloat): Maximum time interval between two generated joint states.</span>

<span class="sd">        dang_min (float | TimeDependentFloat): Minimum angular velocity (rad/s).</span>
<span class="sd">        dang_max (float | TimeDependentFloat): Maximum angular velocity (rad/s).</span>
<span class="sd">        dang_min_free_spherical (float | TimeDependentFloat): Minimum angular velocity for free and spherical joints.</span>
<span class="sd">        dang_max_free_spherical (float | TimeDependentFloat): Maximum angular velocity for free and spherical joints.</span>

<span class="sd">        delta_ang_min (float | TimeDependentFloat): Minimum allowed change in joint angle (radians).</span>
<span class="sd">        delta_ang_max (float | TimeDependentFloat): Maximum allowed change in joint angle (radians).</span>
<span class="sd">        delta_ang_min_free_spherical (float | TimeDependentFloat): Minimum allowed change in angle for free/spherical joints.</span>
<span class="sd">        delta_ang_max_free_spherical (float | TimeDependentFloat): Maximum allowed change in angle for free/spherical joints.</span>

<span class="sd">        dpos_min (float | TimeDependentFloat): Minimum translational velocity.</span>
<span class="sd">        dpos_max (float | TimeDependentFloat): Maximum translational velocity.</span>
<span class="sd">        pos_min (float | TimeDependentFloat): Minimum position constraint.</span>
<span class="sd">        pos_max (float | TimeDependentFloat): Maximum position constraint.</span>

<span class="sd">        pos_min_p3d_x (float | TimeDependentFloat): Minimum position in x-direction for P3D joints.</span>
<span class="sd">        pos_max_p3d_x (float | TimeDependentFloat): Maximum position in x-direction for P3D joints.</span>
<span class="sd">        pos_min_p3d_y (float | TimeDependentFloat): Minimum position in y-direction for P3D joints.</span>
<span class="sd">        pos_max_p3d_y (float | TimeDependentFloat): Maximum position in y-direction for P3D joints.</span>
<span class="sd">        pos_min_p3d_z (float | TimeDependentFloat): Minimum position in z-direction for P3D joints.</span>
<span class="sd">        pos_max_p3d_z (float | TimeDependentFloat): Maximum position in z-direction for P3D joints.</span>

<span class="sd">        cdf_bins_min (int): Minimum number of bins for cumulative distribution function (CDF)-based random sampling.</span>
<span class="sd">        cdf_bins_max (Optional[int]): Maximum number of bins for CDF-based sampling.</span>

<span class="sd">        randomized_interpolation_angle (bool): Whether to use randomized interpolation for angular motion.</span>
<span class="sd">        randomized_interpolation_position (bool): Whether to use randomized interpolation for positional motion.</span>
<span class="sd">        interpolation_method (str): Interpolation method to be used (default: &quot;cosine&quot;).</span>

<span class="sd">        range_of_motion_hinge (bool): Whether to enforce range-of-motion constraints on hinge joints.</span>
<span class="sd">        range_of_motion_hinge_method (str): Method used for range-of-motion enforcement (e.g., &quot;uniform&quot;, &quot;sigmoid&quot;).</span>

<span class="sd">        rom_halfsize (float | TimeDependentFloat): Half-size of the range of motion restriction.</span>

<span class="sd">        ang0_min (float): Minimum initial joint angle.</span>
<span class="sd">        ang0_max (float): Maximum initial joint angle.</span>
<span class="sd">        pos0_min (float): Minimum initial joint position.</span>
<span class="sd">        pos0_max (float): Maximum initial joint position.</span>

<span class="sd">        cor_t_min (float): Minimum time step for center-of-rotation (COR) joints.</span>
<span class="sd">        cor_t_max (float | TimeDependentFloat): Maximum time step for COR joints.</span>
<span class="sd">        cor_dpos_min (float | TimeDependentFloat): Minimum velocity for COR translation.</span>
<span class="sd">        cor_dpos_max (float | TimeDependentFloat): Maximum velocity for COR translation.</span>
<span class="sd">        cor_pos_min (float | TimeDependentFloat): Minimum position for COR translation.</span>
<span class="sd">        cor_pos_max (float | TimeDependentFloat): Maximum position for COR translation.</span>
<span class="sd">        cor_pos0_min (float): Initial minimum position for COR translation.</span>
<span class="sd">        cor_pos0_max (float): Initial maximum position for COR translation.</span>

<span class="sd">        joint_type_specific_overwrites (dict[str, dict[str, Any]]):</span>
<span class="sd">            A dictionary mapping joint types to specific motion configuration overrides.</span>

<span class="sd">    Methods:</span>
<span class="sd">        is_feasible() -&gt; bool:</span>
<span class="sd">            Checks if the motion configuration satisfies all constraints.</span>

<span class="sd">        to_nomotion_config() -&gt; MotionConfig:</span>
<span class="sd">            Returns a new `MotionConfig` where all velocities and angle changes are set to zero.</span>

<span class="sd">        overwrite_for_joint_type(joint_type: str, **changes) -&gt; None:</span>
<span class="sd">            Applies specific configuration changes for a given joint type.</span>
<span class="sd">            Note: These changes affect all instances of `MotionConfig` for this joint type.</span>

<span class="sd">        overwrite_for_subsystem(sys: base.System, link_name: str, **changes) -&gt; base.System:</span>
<span class="sd">            Modifies the motion configuration for all joints in a subsystem rooted at `link_name`.</span>

<span class="sd">        from_register(name: str) -&gt; &quot;MotionConfig&quot;:</span>
<span class="sd">            Retrieves a predefined `MotionConfig` from the global registry.</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

    <span class="n">T</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">60.0</span>  <span class="c1"># length of random motion</span>
    <span class="n">t_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># min time between two generated angles</span>
    <span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.30</span>  <span class="c1"># max time ..</span>

    <span class="n">dang_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># minimum angular velocity in rad/s</span>
    <span class="n">dang_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># maximum angular velocity in rad/s</span>

    <span class="c1"># minimum angular velocity of euler angles used for `free and spherical joints`</span>
    <span class="n">dang_min_free_spherical</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">dang_max_free_spherical</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">3.0</span>

    <span class="c1"># max min allowed actual delta values in radians</span>
    <span class="n">delta_ang_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">delta_ang_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">delta_ang_min_free_spherical</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">delta_ang_max_free_spherical</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>

    <span class="n">dpos_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># speed of translation</span>
    <span class="n">dpos_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="n">pos_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span>
    <span class="n">pos_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">+</span><span class="mf">2.5</span>
    <span class="n">pos_min_p3d_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span>
    <span class="n">pos_max_p3d_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">+</span><span class="mf">2.5</span>
    <span class="n">pos_min_p3d_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span>
    <span class="n">pos_max_p3d_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">+</span><span class="mf">2.5</span>
    <span class="n">pos_min_p3d_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span>
    <span class="n">pos_max_p3d_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">+</span><span class="mf">2.5</span>

    <span class="c1"># used by both `random_angle_*` and `random_pos_*`</span>
    <span class="c1"># only used if `randomized_interpolation` is set</span>
    <span class="n">cdf_bins_min</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="c1"># by default equal to `cdf_bins_min`</span>
    <span class="n">cdf_bins_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># flags</span>
    <span class="n">randomized_interpolation_angle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">randomized_interpolation_position</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">interpolation_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cosine&quot;</span>
    <span class="n">range_of_motion_hinge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">range_of_motion_hinge_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uniform&quot;</span>

    <span class="c1"># this value has nothing to do with `range_of_motion` flag</span>
    <span class="c1"># this forces the value to stay within [ANG_0 - rom_halfsize, ANG_0 + rom_halfsize]</span>
    <span class="c1"># used only by the `_draw_rxyz` function</span>
    <span class="n">rom_halfsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>

    <span class="c1"># initial value of joints</span>
    <span class="n">ang0_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">ang0_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">pos0_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pos0_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pos0_min_p3d_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pos0_max_p3d_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pos0_min_p3d_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pos0_max_p3d_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pos0_min_p3d_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pos0_max_p3d_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># cor (center of rotation) custom fields</span>
    <span class="n">cor_t_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">cor_t_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">cor_dpos_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.00001</span>
    <span class="n">cor_dpos_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">cor_pos_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.4</span>
    <span class="n">cor_pos_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="n">cor_pos0_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cor_pos0_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># specify changes for this motionconfig and for specific joint types</span>
    <span class="c1"># map of `link_types` -&gt; dictionary of changes</span>
    <span class="n">joint_type_specific_overwrites</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_feasible</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_is_feasible_config1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_nomotion_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MotionConfig&quot;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;dang_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dang_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta_ang_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dang_min_free_spherical&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dang_max_free_spherical&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta_ang_min_free_spherical&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dpos_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dpos_max&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">nomotion_config</span> <span class="o">=</span> <span class="n">MotionConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nomotion_config</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nomotion_config</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">overwrite_for_joint_type</span><span class="p">(</span><span class="n">joint_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Changes values of the `MotionConfig` used by the draw_fn for only a specific</span>
<span class="sd">        joint.</span>
<span class="sd">        !!! Note</span>
<span class="sd">            This applies these changes to *all* MotionConfigs for this joint type!</span>
<span class="sd">            This takes precedence *over* `Motionconfig.joint_type_specific_overwrites`!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">previous_changes</span> <span class="o">=</span> <span class="n">_overwrite_for_joint_type_changes</span><span class="p">[</span><span class="n">joint_type</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">change</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_changes</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;For jointtype=</span><span class="si">{</span><span class="n">joint_type</span><span class="si">}</span><span class="s2"> you &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;previously changed the value=</span><span class="si">{</span><span class="n">change</span><span class="si">}</span><span class="s2">. You can&#39;t change it again, this &quot;</span>
            <span class="s2">&quot;is not supported.&quot;</span>
        <span class="n">previous_changes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>

        <span class="n">jm</span> <span class="o">=</span> <span class="n">get_joint_model</span><span class="p">(</span><span class="n">joint_type</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jm</span><span class="o">.</span><span class="n">rcmg_draw_fn</span><span class="p">(</span><span class="n">replace</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="n">register_new_joint_type</span><span class="p">(</span>
            <span class="n">joint_type</span><span class="p">,</span>
            <span class="n">replace</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span> <span class="n">rcmg_draw_fn</span><span class="o">=</span><span class="n">draw_fn</span><span class="p">),</span>
            <span class="n">base</span><span class="o">.</span><span class="n">Q_WIDTHS</span><span class="p">[</span><span class="n">joint_type</span><span class="p">],</span>
            <span class="n">base</span><span class="o">.</span><span class="n">QD_WIDTHS</span><span class="p">[</span><span class="n">joint_type</span><span class="p">],</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">overwrite_for_subsystem</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">link_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modifies motionconfig of all joints in subsystem with root `link_name`.</span>
<span class="sd">        Note that if the subsystem contains a free joint then the jointtype will</span>
<span class="sd">        will be re-named to `free_&lt;link_name&gt;`, then the RCMG flag `cor` will</span>
<span class="sd">        potentially not work as expected because it searches for all joints of</span>
<span class="sd">        type `free` to replace with `cor`. The workaround here is to change the</span>
<span class="sd">        type already from `free` to `cor in the xml file.</span>
<span class="sd">        This takes precedence *over* `Motionconfig.joint_type_specific_overwrites`!</span>

<span class="sd">        Args:</span>
<span class="sd">            sys (base.System): System object that gets updated</span>
<span class="sd">            link_name (str): Root node of subsystem</span>
<span class="sd">            changes: Changes to apply to the motionconfig</span>

<span class="sd">        Return:</span>
<span class="sd">            base.System: Updated system with new jointtypes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ring.algorithms.generator.finalize_fns</span> <span class="kn">import</span> <span class="n">_P_gains</span>

        <span class="c1"># all bodies in the subsystem</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">findall_bodies_subsystem</span><span class="p">(</span><span class="n">link_name</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">link_name</span><span class="p">)]</span>

        <span class="n">jts_subsys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;frozen&quot;</span><span class="p">])</span>
        <span class="n">postfix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">link_name</span>
        <span class="c1"># create new joint types with updated motionconfig</span>
        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">jts_subsys</span><span class="p">:</span>
            <span class="n">register_new_joint_type</span><span class="p">(</span>
                <span class="n">typ</span> <span class="o">+</span> <span class="n">postfix</span><span class="p">,</span>
                <span class="n">get_joint_model</span><span class="p">(</span><span class="n">typ</span><span class="p">),</span>
                <span class="n">base</span><span class="o">.</span><span class="n">Q_WIDTHS</span><span class="p">[</span><span class="n">typ</span><span class="p">],</span>
                <span class="n">base</span><span class="o">.</span><span class="n">QD_WIDTHS</span><span class="p">[</span><span class="n">typ</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">MotionConfig</span><span class="o">.</span><span class="n">overwrite_for_joint_type</span><span class="p">(</span><span class="n">typ</span> <span class="o">+</span> <span class="n">postfix</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span>
            <span class="n">_P_gains</span><span class="p">[</span><span class="n">typ</span> <span class="o">+</span> <span class="n">postfix</span><span class="p">]</span> <span class="o">=</span> <span class="n">_P_gains</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>

        <span class="c1"># rename all jointtypes</span>
        <span class="n">new_link_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">postfix</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">bodies</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;frozen&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">num_links</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="n">sys</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">link_types</span><span class="o">=</span><span class="n">new_link_types</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sys</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_register</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MotionConfig&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_registered_motion_configs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h5 id="src.ring.algorithms.jcalc.MotionConfig.overwrite_for_joint_type" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">overwrite_for_joint_type</span><span class="p">(</span><span class="n">joint_type</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.ring.algorithms.jcalc.MotionConfig.overwrite_for_joint_type" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Changes values of the <code>MotionConfig</code> used by the draw_fn for only a specific
joint.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This applies these changes to <em>all</em> MotionConfigs for this joint type!
This takes precedence <em>over</em> <code>Motionconfig.joint_type_specific_overwrites</code>!</p>
</div>

          <details class="quote">
            <summary>Source code in <code>src/ring/algorithms/jcalc.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">overwrite_for_joint_type</span><span class="p">(</span><span class="n">joint_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Changes values of the `MotionConfig` used by the draw_fn for only a specific</span>
<span class="sd">    joint.</span>
<span class="sd">    !!! Note</span>
<span class="sd">        This applies these changes to *all* MotionConfigs for this joint type!</span>
<span class="sd">        This takes precedence *over* `Motionconfig.joint_type_specific_overwrites`!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">previous_changes</span> <span class="o">=</span> <span class="n">_overwrite_for_joint_type_changes</span><span class="p">[</span><span class="n">joint_type</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">change</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_changes</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;For jointtype=</span><span class="si">{</span><span class="n">joint_type</span><span class="si">}</span><span class="s2"> you &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;previously changed the value=</span><span class="si">{</span><span class="n">change</span><span class="si">}</span><span class="s2">. You can&#39;t change it again, this &quot;</span>
        <span class="s2">&quot;is not supported.&quot;</span>
    <span class="n">previous_changes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>

    <span class="n">jm</span> <span class="o">=</span> <span class="n">get_joint_model</span><span class="p">(</span><span class="n">joint_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jm</span><span class="o">.</span><span class="n">rcmg_draw_fn</span><span class="p">(</span><span class="n">replace</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="n">register_new_joint_type</span><span class="p">(</span>
        <span class="n">joint_type</span><span class="p">,</span>
        <span class="n">replace</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span> <span class="n">rcmg_draw_fn</span><span class="o">=</span><span class="n">draw_fn</span><span class="p">),</span>
        <span class="n">base</span><span class="o">.</span><span class="n">Q_WIDTHS</span><span class="p">[</span><span class="n">joint_type</span><span class="p">],</span>
        <span class="n">base</span><span class="o">.</span><span class="n">QD_WIDTHS</span><span class="p">[</span><span class="n">joint_type</span><span class="p">],</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h5 id="src.ring.algorithms.jcalc.MotionConfig.overwrite_for_subsystem" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">overwrite_for_subsystem</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">link_name</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.ring.algorithms.jcalc.MotionConfig.overwrite_for_subsystem" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Modifies motionconfig of all joints in subsystem with root <code>link_name</code>.
Note that if the subsystem contains a free joint then the jointtype will
will be re-named to <code>free_&lt;link_name&gt;</code>, then the RCMG flag <code>cor</code> will
potentially not work as expected because it searches for all joints of
type <code>free</code> to replace with <code>cor</code>. The workaround here is to change the
type already from <code>free</code> to <code>cor in the xml file.
This takes precedence *over*</code>Motionconfig.joint_type_specific_overwrites`!</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>sys</code></b>
                  (<code><span title="ring.base.System">System</span></code>)
              –
              <div class="doc-md-description">
                <p>System object that gets updated</p>
              </div>
            </li>
            <li>
              <b><code>link_name</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Root node of subsystem</p>
              </div>
            </li>
            <li>
              <b><code>changes</code></b>
              –
              <div class="doc-md-description">
                <p>Changes to apply to the motionconfig</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<details class="return" open>
  <summary>Return</summary>
  <p>base.System: Updated system with new jointtypes</p>
</details>
          <details class="quote">
            <summary>Source code in <code>src/ring/algorithms/jcalc.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">overwrite_for_subsystem</span><span class="p">(</span>
    <span class="n">sys</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">link_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modifies motionconfig of all joints in subsystem with root `link_name`.</span>
<span class="sd">    Note that if the subsystem contains a free joint then the jointtype will</span>
<span class="sd">    will be re-named to `free_&lt;link_name&gt;`, then the RCMG flag `cor` will</span>
<span class="sd">    potentially not work as expected because it searches for all joints of</span>
<span class="sd">    type `free` to replace with `cor`. The workaround here is to change the</span>
<span class="sd">    type already from `free` to `cor in the xml file.</span>
<span class="sd">    This takes precedence *over* `Motionconfig.joint_type_specific_overwrites`!</span>

<span class="sd">    Args:</span>
<span class="sd">        sys (base.System): System object that gets updated</span>
<span class="sd">        link_name (str): Root node of subsystem</span>
<span class="sd">        changes: Changes to apply to the motionconfig</span>

<span class="sd">    Return:</span>
<span class="sd">        base.System: Updated system with new jointtypes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ring.algorithms.generator.finalize_fns</span> <span class="kn">import</span> <span class="n">_P_gains</span>

    <span class="c1"># all bodies in the subsystem</span>
    <span class="n">bodies</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">findall_bodies_subsystem</span><span class="p">(</span><span class="n">link_name</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">link_name</span><span class="p">)]</span>

    <span class="n">jts_subsys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;frozen&quot;</span><span class="p">])</span>
    <span class="n">postfix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">link_name</span>
    <span class="c1"># create new joint types with updated motionconfig</span>
    <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">jts_subsys</span><span class="p">:</span>
        <span class="n">register_new_joint_type</span><span class="p">(</span>
            <span class="n">typ</span> <span class="o">+</span> <span class="n">postfix</span><span class="p">,</span>
            <span class="n">get_joint_model</span><span class="p">(</span><span class="n">typ</span><span class="p">),</span>
            <span class="n">base</span><span class="o">.</span><span class="n">Q_WIDTHS</span><span class="p">[</span><span class="n">typ</span><span class="p">],</span>
            <span class="n">base</span><span class="o">.</span><span class="n">QD_WIDTHS</span><span class="p">[</span><span class="n">typ</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">MotionConfig</span><span class="o">.</span><span class="n">overwrite_for_joint_type</span><span class="p">(</span><span class="n">typ</span> <span class="o">+</span> <span class="n">postfix</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span>
        <span class="n">_P_gains</span><span class="p">[</span><span class="n">typ</span> <span class="o">+</span> <span class="n">postfix</span><span class="p">]</span> <span class="o">=</span> <span class="n">_P_gains</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>

    <span class="c1"># rename all jointtypes</span>
    <span class="n">new_link_types</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">postfix</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">bodies</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;frozen&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">num_links</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="n">sys</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">link_types</span><span class="o">=</span><span class="n">new_link_types</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sys</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div><hr />



<div class="doc doc-object doc-function">



<h4 id="src.ring.algorithms.jcalc.join_motionconfigs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">join_motionconfigs</span><span class="p">(</span><span class="n">configs</span><span class="p">,</span> <span class="n">boundaries</span><span class="p">)</span></code>

<a href="#src.ring.algorithms.jcalc.join_motionconfigs" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">
  
      <p>Joins multiple <code>MotionConfig</code> objects in time, transitioning between them at specified boundaries.</p>
<p>This function takes a list of <code>MotionConfig</code> instances and a corresponding list of boundary times,
and constructs a new <code>MotionConfig</code> that varies in time according to the provided segments.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>configs</code></b>
                  (<code>list[<a class="autorefs autorefs-internal" title="src.ring.algorithms.jcalc.MotionConfig" href="#src.ring.algorithms.jcalc.MotionConfig">MotionConfig</a>]</code>)
              –
              <div class="doc-md-description">
                <p>A list of <code>MotionConfig</code> objects to be joined.</p>
              </div>
            </li>
            <li>
              <b><code>boundaries</code></b>
                  (<code>list[float]</code>)
              –
              <div class="doc-md-description">
                <p>A list of time values where transitions between <code>configs</code> occur.
Must have one element less than <code>configs</code>, as each boundary defines the transition point
between two consecutive configurations.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b><code>MotionConfig</code></b>(                <code><a class="autorefs autorefs-internal" title="src.ring.algorithms.jcalc.MotionConfig" href="#src.ring.algorithms.jcalc.MotionConfig">MotionConfig</a></code>
)            –
            <div class="doc-md-description">
              <p>A new <code>MotionConfig</code> object where time-dependent fields transition based on the</p>
            </div>
          </li>
          <li>
                <code><a class="autorefs autorefs-internal" title="src.ring.algorithms.jcalc.MotionConfig" href="#src.ring.algorithms.jcalc.MotionConfig">MotionConfig</a></code>
            –
            <div class="doc-md-description">
              <p>specified boundaries.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code>AssertionError</code>
              –
              <div class="doc-md-description">
                <p>If the number of boundaries does not match <code>len(configs) - 1</code>.</p>
              </div>
            </li>
            <li>
                  <code>AssertionError</code>
              –
              <div class="doc-md-description">
                <p>If time-independent fields have differing values across <code>configs</code>.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Only fields that are time-dependent (<code>float | TimeDependentFloat</code>) will change over time.</li>
<li>Time-independent fields must be the same in all <code>configs</code>, or an error is raised.</li>
</ul>
</details>
          <details class="quote">
            <summary>Source code in <code>src/ring/algorithms/jcalc.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">join_motionconfigs</span><span class="p">(</span>
    <span class="n">configs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">MotionConfig</span><span class="p">],</span> <span class="n">boundaries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MotionConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Joins multiple `MotionConfig` objects in time, transitioning between them at specified boundaries.</span>

<span class="sd">    This function takes a list of `MotionConfig` instances and a corresponding list of boundary times,</span>
<span class="sd">    and constructs a new `MotionConfig` that varies in time according to the provided segments.</span>

<span class="sd">    Args:</span>
<span class="sd">        configs (list[MotionConfig]): A list of `MotionConfig` objects to be joined.</span>
<span class="sd">        boundaries (list[float]): A list of time values where transitions between `configs` occur.</span>
<span class="sd">            Must have one element less than `configs`, as each boundary defines the transition point</span>
<span class="sd">            between two consecutive configurations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        MotionConfig: A new `MotionConfig` object where time-dependent fields transition based on the</span>
<span class="sd">        specified boundaries.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If the number of boundaries does not match `len(configs) - 1`.</span>
<span class="sd">        AssertionError: If time-independent fields have differing values across `configs`.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Only fields that are time-dependent (`float | TimeDependentFloat`) will change over time.</span>
<span class="sd">        - Time-independent fields must be the same in all `configs`, or an error is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
    <span class="c1"># to avoid a circular import due to `ring.utils.randomize_sys` importing `jcalc`</span>
    <span class="kn">from</span> <span class="nn">ring.utils</span> <span class="kn">import</span> <span class="n">tree_equal</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">boundaries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">),</span> <span class="s2">&quot;length of `boundaries` should be one less than length of `configs`&quot;</span>
    <span class="n">boundaries</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_value</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">scalar_options</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_index_in_dim</span><span class="p">(</span>
                <span class="n">scalar_options</span><span class="p">,</span> <span class="n">_find_interval</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">boundaries</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">scalar</span>

    <span class="n">hints</span> <span class="o">=</span> <span class="n">get_type_hints</span><span class="p">(</span><span class="n">MotionConfig</span><span class="p">())</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">MotionConfig</span><span class="p">()</span><span class="o">.</span><span class="vm">__dict__</span>
    <span class="n">is_time_dependent_field</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">hints</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="nb">float</span> <span class="o">|</span> <span class="n">TimeDependentFloat</span><span class="p">)</span>
    <span class="n">time_dependent_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">is_time_dependent_field</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
    <span class="n">time_independent_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_time_dependent_field</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">time_dep_field</span> <span class="ow">in</span> <span class="n">time_independent_fields</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">time_dep_field</span><span class="p">)</span> <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">])</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;MotionConfig.</span><span class="si">{</span><span class="n">time_dep_field</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">field_values</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;Should be one unique value..&quot;</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="ne">TypeError</span>
        <span class="p">):</span>  <span class="c1"># dict is not hashable so test equality of all elements differently</span>
            <span class="n">comparison_ele</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_dep_field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">other_config</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">other_ele</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other_config</span><span class="p">,</span> <span class="n">time_dep_field</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">tree_equal</span><span class="p">(</span>
                    <span class="n">comparison_ele</span><span class="p">,</span> <span class="n">other_ele</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;MotionConfig.</span><span class="si">{</span><span class="n">time_dep_field</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">comparison_ele</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">other_ele</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="s2">&quot; Should be one unique value..&quot;</span>

    <span class="n">changes</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">new_value</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">time_dependent_fields</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div><h3 id="extending-the-rcmg">Extending the RCMG<a class="headerlink" href="#extending-the-rcmg" title="Permanent link">¤</a></h3>


<div class="doc doc-object doc-class">



<h4 id="src.ring.algorithms.jcalc.JointModel" class="doc doc-heading">
          <code>JointModel</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#src.ring.algorithms.jcalc.JointModel" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">

  
      <p>Represents the kinematic and dynamic properties of a joint type.</p>
<p>A <code>JointModel</code> defines the mathematical functions required to compute joint
transformations, motion, control terms, and inverse kinematics. It is used to
describe the behavior of various joint types, including revolute, prismatic,
spherical, and free joints.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Attributes:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>transform</code></b>
                  (<code><span title="typing.Callable">Callable</span>[[<span title="jax.Array">Array</span>, <span title="jax.Array">Array</span>], <span title="ring.base.Transform">Transform</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Computes the transformation (position and orientation) of the joint
given the joint state <code>q</code> and joint parameters.</p>
              </div>
            </li>
            <li>
              <b><code>motion</code></b>
                  (<code>list[<span title="ring.base.Motion">Motion</span> | <span title="typing.Callable">Callable</span>[[<span title="jax.Array">Array</span>], <span title="ring.base.Motion">Motion</span>]]</code>)
              –
              <div class="doc-md-description">
                <p>Defines the joint motion model. It can be a list of <code>Motion</code> objects
or callables that return <code>Motion</code> based on joint parameters.</p>
              </div>
            </li>
            <li>
              <b><code>rcmg_draw_fn</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="src.ring.algorithms.jcalc.DRAW_FN">DRAW_FN</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Function used to generate a reference motion trajectory for the joint
using Randomized Control Motion Generation (RCMG).</p>
              </div>
            </li>
            <li>
              <b><code>p_control_term</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="src.ring.algorithms.jcalc.P_CONTROL_TERM">P_CONTROL_TERM</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Function that computes the proportional control term for the joint.</p>
              </div>
            </li>
            <li>
              <b><code>qd_from_q</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="src.ring.algorithms.jcalc.QD_FROM_Q">QD_FROM_Q</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Function to compute joint velocity (<code>qd</code>) from joint positions (<code>q</code>).</p>
              </div>
            </li>
            <li>
              <b><code>coordinate_vector_to_q</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="src.ring.algorithms.jcalc.COORDINATE_VECTOR_TO_Q">COORDINATE_VECTOR_TO_Q</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Function that maps a coordinate vector to a valid joint state <code>q</code>,
ensuring constraints (e.g., wrapping angles or normalizing quaternions).</p>
              </div>
            </li>
            <li>
              <b><code>inv_kin</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="src.ring.algorithms.jcalc.INV_KIN">INV_KIN</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Function that computes the inverse kinematics for the joint, mapping
a desired transform to joint coordinates <code>q</code>.</p>
              </div>
            </li>
            <li>
              <b><code>init_joint_params</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="src.ring.algorithms.jcalc.INIT_JOINT_PARAMS">INIT_JOINT_PARAMS</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Function that initializes joint-specific parameters.</p>
              </div>
            </li>
            <li>
              <b><code>utilities</code></b>
                  (<code><span title="typing.Optional">Optional</span>[dict[str, <span title="typing.Any">Any</span>]]</code>)
              –
              <div class="doc-md-description">
                <p>Additional utility functions or metadata related to the joint model.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>The <code>transform</code> function is essential for computing the joint's spatial
  transformation based on its generalized coordinates.</li>
<li>The <code>motion</code> attribute describes how forces and torques affect the joint.</li>
<li>The <code>rcmg_draw_fn</code> is used for RCMG motion generation.</li>
<li>The <code>coordinate_vector_to_q</code> is critical for maintaining valid joint states.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>src/ring/algorithms/jcalc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">JointModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the kinematic and dynamic properties of a joint type.</span>

<span class="sd">    A `JointModel` defines the mathematical functions required to compute joint</span>
<span class="sd">    transformations, motion, control terms, and inverse kinematics. It is used to</span>
<span class="sd">    describe the behavior of various joint types, including revolute, prismatic,</span>
<span class="sd">    spherical, and free joints.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        transform (Callable[[jax.Array, jax.Array], base.Transform]):</span>
<span class="sd">            Computes the transformation (position and orientation) of the joint</span>
<span class="sd">            given the joint state `q` and joint parameters.</span>

<span class="sd">        motion (list[base.Motion | Callable[[jax.Array], base.Motion]]):</span>
<span class="sd">            Defines the joint motion model. It can be a list of `Motion` objects</span>
<span class="sd">            or callables that return `Motion` based on joint parameters.</span>

<span class="sd">        rcmg_draw_fn (Optional[DRAW_FN]):</span>
<span class="sd">            Function used to generate a reference motion trajectory for the joint</span>
<span class="sd">            using Randomized Control Motion Generation (RCMG).</span>

<span class="sd">        p_control_term (Optional[P_CONTROL_TERM]):</span>
<span class="sd">            Function that computes the proportional control term for the joint.</span>

<span class="sd">        qd_from_q (Optional[QD_FROM_Q]):</span>
<span class="sd">            Function to compute joint velocity (`qd`) from joint positions (`q`).</span>

<span class="sd">        coordinate_vector_to_q (Optional[COORDINATE_VECTOR_TO_Q]):</span>
<span class="sd">            Function that maps a coordinate vector to a valid joint state `q`,</span>
<span class="sd">            ensuring constraints (e.g., wrapping angles or normalizing quaternions).</span>

<span class="sd">        inv_kin (Optional[INV_KIN]):</span>
<span class="sd">            Function that computes the inverse kinematics for the joint, mapping</span>
<span class="sd">            a desired transform to joint coordinates `q`.</span>

<span class="sd">        init_joint_params (Optional[INIT_JOINT_PARAMS]):</span>
<span class="sd">            Function that initializes joint-specific parameters.</span>

<span class="sd">        utilities (Optional[dict[str, Any]]):</span>
<span class="sd">            Additional utility functions or metadata related to the joint model.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - The `transform` function is essential for computing the joint&#39;s spatial</span>
<span class="sd">          transformation based on its generalized coordinates.</span>
<span class="sd">        - The `motion` attribute describes how forces and torques affect the joint.</span>
<span class="sd">        - The `rcmg_draw_fn` is used for RCMG motion generation.</span>
<span class="sd">        - The `coordinate_vector_to_q` is critical for maintaining valid joint states.</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

    <span class="c1"># (q, params) -&gt; Transform</span>
    <span class="n">transform</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">base</span><span class="o">.</span><span class="n">Transform</span><span class="p">]</span>
    <span class="c1"># len(motion) == len(qd)</span>
    <span class="c1"># if callable: joint_params -&gt; base.Motion</span>
    <span class="n">motion</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">base</span><span class="o">.</span><span class="n">Motion</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">base</span><span class="o">.</span><span class="n">Motion</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">)</span>
    <span class="c1"># (config, key_t, key_value, params) -&gt; jax.Array</span>
    <span class="n">rcmg_draw_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DRAW_FN</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># only used by `pd_control`</span>
    <span class="n">p_control_term</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">P_CONTROL_TERM</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">qd_from_q</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QD_FROM_Q</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># used by</span>
    <span class="c1"># -`inverse_kinematics_endeffector`</span>
    <span class="c1"># - System.coordinate_vector_to_q</span>
    <span class="n">coordinate_vector_to_q</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">COORDINATE_VECTOR_TO_Q</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># only used by `inverse_kinematics`</span>
    <span class="n">inv_kin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">INV_KIN</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">init_joint_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">INIT_JOINT_PARAMS</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">utilities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">dict</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>


</div><hr />



<div class="doc doc-object doc-function">



<h4 id="src.ring.algorithms.jcalc.register_new_joint_type" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">register_new_joint_type</span><span class="p">(</span><span class="n">joint_type</span><span class="p">,</span> <span class="n">joint_model</span><span class="p">,</span> <span class="n">q_width</span><span class="p">,</span> <span class="n">qd_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#src.ring.algorithms.jcalc.register_new_joint_type" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">

          <details class="quote">
            <summary>Source code in <code>src/ring/algorithms/jcalc.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">register_new_joint_type</span><span class="p">(</span>
    <span class="n">joint_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">joint_model</span><span class="p">:</span> <span class="n">JointModel</span><span class="p">,</span>
    <span class="n">q_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">qd_width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># this name is used</span>
    <span class="k">assert</span> <span class="n">joint_type</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;Please use another name.&quot;</span>

    <span class="n">exists</span> <span class="o">=</span> <span class="n">joint_type</span> <span class="ow">in</span> <span class="n">_joint_types</span>
    <span class="k">if</span> <span class="n">exists</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dic</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">base</span><span class="o">.</span><span class="n">Q_WIDTHS</span><span class="p">,</span>
            <span class="n">base</span><span class="o">.</span><span class="n">QD_WIDTHS</span><span class="p">,</span>
            <span class="n">_joint_types</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">dic</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">joint_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">exists</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;joint type `</span><span class="si">{</span><span class="n">joint_type</span><span class="si">}</span><span class="s2">`already exists, use `overwrite=True`&quot;</span>

    <span class="k">if</span> <span class="n">qd_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">qd_width</span> <span class="o">=</span> <span class="n">q_width</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_model</span><span class="o">.</span><span class="n">motion</span><span class="p">)</span> <span class="o">==</span> <span class="n">qd_width</span>

    <span class="n">_joint_types</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">joint_type</span><span class="p">:</span> <span class="n">joint_model</span><span class="p">})</span>
    <span class="n">base</span><span class="o">.</span><span class="n">Q_WIDTHS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">joint_type</span><span class="p">:</span> <span class="n">q_width</span><span class="p">})</span>
    <span class="n">base</span><span class="o">.</span><span class="n">QD_WIDTHS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">joint_type</span><span class="p">:</span> <span class="n">qd_width</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div><h2 id="simulation">Simulation<a class="headerlink" href="#simulation" title="Permanent link">¤</a></h2>


<div class="doc doc-object doc-class">



<h4 id="src.ring.base.State" class="doc doc-heading">
          <code>State</code>


<a href="#src.ring.base.State" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">

  
      <p>The static and dynamic state of a system in minimal and maximal coordinates.
Use <code>.create()</code> to create this object.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>q</code></b>
                  (<code><span title="jax.Array">Array</span></code>)
              –
              <div class="doc-md-description">
                <p>System state in minimal coordinates (equals <code>sys.q_size()</code>)</p>
              </div>
            </li>
            <li>
              <b><code>qd</code></b>
                  (<code><span title="jax.Array">Array</span></code>)
              –
              <div class="doc-md-description">
                <p>System velocity in minimal coordinates (equals <code>sys.qd_size()</code>)</p>
              </div>
            </li>
            <li>
              <b><code>x</code></b>
              –
              <div class="doc-md-description">
                <p>(Transform): Maximal coordinates of all links. From epsilon-to-link.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>src/ring/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@struct</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">_Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The static and dynamic state of a system in minimal and maximal coordinates.</span>
<span class="sd">    Use `.create()` to create this object.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (jax.Array): System state in minimal coordinates (equals `sys.q_size()`)</span>
<span class="sd">        qd (jax.Array): System velocity in minimal coordinates (equals `sys.qd_size()`)</span>
<span class="sd">        x: (Transform): Maximal coordinates of all links. From epsilon-to-link.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">qd</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Transform</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">sys</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">qd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Transform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_joints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create state of system.</span>

<span class="sd">        Args:</span>
<span class="sd">            sys (System): The system for which to create a state.</span>
<span class="sd">            q (jax.Array, optional): The joint values of the system. Defaults to None.</span>
<span class="sd">            Which then defaults to zeros.</span>
<span class="sd">            qd (jax.Array, optional): The joint velocities of the system.</span>
<span class="sd">            Defaults to None. Which then defaults to zeros.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (State): Create State object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">q_size</span><span class="p">(),))</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">coordinate_vector_to_q</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">custom_joints</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sys</span><span class="o">.</span><span class="n">q_size</span><span class="p">(),))</span>

            <span class="c1"># free, cor, spherical joints are not zeros but have unit quaternions</span>
            <span class="k">def</span> <span class="nf">replace_by_unit_quat</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">idx_map</span><span class="p">,</span> <span class="n">link_typ</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">):</span>
                <span class="k">nonlocal</span> <span class="n">q</span>

                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">joint_type_is_free_or_cor_or_spherical</span><span class="p">(</span><span class="n">link_typ</span><span class="p">):</span>
                    <span class="n">q_idxs_link</span> <span class="o">=</span> <span class="n">idx_map</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">](</span><span class="n">link_idx</span><span class="p">)</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">q_idxs_link</span><span class="o">.</span><span class="n">start</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
                <span class="n">replace_by_unit_quat</span><span class="p">,</span>
                <span class="s2">&quot;ll&quot;</span><span class="p">,</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">,</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">num_links</span><span class="p">())),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">qd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qd</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sys</span><span class="o">.</span><span class="n">qd_size</span><span class="p">(),))</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">Transform</span><span class="o">.</span><span class="n">zero</span><span class="p">((</span><span class="n">sys</span><span class="o">.</span><span class="n">num_links</span><span class="p">(),))</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">qd</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h5 id="src.ring.base.State.create" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">custom_joints</span><span class="o">=</span><span class="p">{})</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.ring.base.State.create" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Create state of system.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>sys</code></b>
                  (<code><a class="autorefs autorefs-internal" title="src.ring.base.System" href="#src.ring.base.System">System</a></code>)
              –
              <div class="doc-md-description">
                <p>The system for which to create a state.</p>
              </div>
            </li>
            <li>
              <b><code>q</code></b>
                  (<code><span title="jax.Array">Array</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The joint values of the system. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>qd</code></b>
                  (<code><span title="jax.Array">Array</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The joint velocities of the system.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code><a class="autorefs autorefs-internal" title="src.ring.base.State" href="#src.ring.base.State">State</a></code>
            –
            <div class="doc-md-description">
              <p>Create State object.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">sys</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span>
    <span class="n">q</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">qd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Transform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">custom_joints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create state of system.</span>

<span class="sd">    Args:</span>
<span class="sd">        sys (System): The system for which to create a state.</span>
<span class="sd">        q (jax.Array, optional): The joint values of the system. Defaults to None.</span>
<span class="sd">        Which then defaults to zeros.</span>
<span class="sd">        qd (jax.Array, optional): The joint velocities of the system.</span>
<span class="sd">        Defaults to None. Which then defaults to zeros.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (State): Create State object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">q_size</span><span class="p">(),))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">coordinate_vector_to_q</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">custom_joints</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sys</span><span class="o">.</span><span class="n">q_size</span><span class="p">(),))</span>

        <span class="c1"># free, cor, spherical joints are not zeros but have unit quaternions</span>
        <span class="k">def</span> <span class="nf">replace_by_unit_quat</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">idx_map</span><span class="p">,</span> <span class="n">link_typ</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">q</span>

            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">joint_type_is_free_or_cor_or_spherical</span><span class="p">(</span><span class="n">link_typ</span><span class="p">):</span>
                <span class="n">q_idxs_link</span> <span class="o">=</span> <span class="n">idx_map</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">](</span><span class="n">link_idx</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">q_idxs_link</span><span class="o">.</span><span class="n">start</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
            <span class="n">replace_by_unit_quat</span><span class="p">,</span>
            <span class="s2">&quot;ll&quot;</span><span class="p">,</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">link_types</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">num_links</span><span class="p">())),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">qd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">qd</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sys</span><span class="o">.</span><span class="n">qd_size</span><span class="p">(),))</span>

    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Transform</span><span class="o">.</span><span class="n">zero</span><span class="p">((</span><span class="n">sys</span><span class="o">.</span><span class="n">num_links</span><span class="p">(),))</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">qd</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div><hr />



<div class="doc doc-object doc-function">



<h4 id="src.ring.algorithms.dynamics.step" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">step</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">taus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_substeps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#src.ring.algorithms.dynamics.step" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">
  
      <p>Steps the dynamics. Returns the state of next timestep.</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/algorithms/dynamics.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
    <span class="n">sys</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">System</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
    <span class="n">taus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_substeps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">base</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
    <span class="s2">&quot;Steps the dynamics. Returns the state of next timestep.&quot;</span>
    <span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">q_size</span><span class="p">()</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">taus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">taus</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">qd</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">qd_size</span><span class="p">()</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">qd</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">taus</span><span class="o">.</span><span class="n">size</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">integration_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;semi_implicit_euler&quot;</span>
    <span class="p">),</span> <span class="s2">&quot;Currently, nothing else then `semi_implicit_euler` implemented.&quot;</span>

    <span class="n">sys</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="n">n_substeps</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_substeps</span><span class="p">):</span>
        <span class="c1"># update kinematics before stepping; this means that the `x` in `state`</span>
        <span class="c1"># will lag one step behind but otherwise we would have to return</span>
        <span class="c1"># the system object which would be awkward</span>
        <span class="n">sys</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">kinematics</span><span class="o">.</span><span class="n">forward_kinematics</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">_integration_methods</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">integration_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()](</span><span class="n">sys</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">taus</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div><hr />


<div class="doc doc-object doc-class">



<h4 id="src.ring.base.Transform" class="doc doc-heading">
          <code>Transform</code>


<a href="#src.ring.base.Transform" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">

  
      <p>Represents the Transformation from Plücker A to Plücker B,
where B is located relative to A at <code>pos</code> in frame A and <code>rot</code> is the
relative quaternion from A to B.
Create using `Transform.create(pos=..., rot=...)</p>

            <details class="quote">
              <summary>Source code in <code>src/ring/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@struct</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Transform</span><span class="p">(</span><span class="n">_Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the Transformation from Plücker A to Plücker B,</span>
<span class="sd">    where B is located relative to A at `pos` in frame A and `rot` is the</span>
<span class="sd">    relative quaternion from A to B.</span>
<span class="sd">    Create using `Transform.create(pos=..., rot=...)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pos</span><span class="p">:</span> <span class="n">Vector</span>
    <span class="n">rot</span><span class="p">:</span> <span class="n">Quaternion</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;One must be given.&quot;</span>
        <span class="n">shape_rot</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">rot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">shape_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">()</span>

        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape_rot</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">rot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="n">shape_pos</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

        <span class="k">assert</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">rot</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Transform</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">zero</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="s2">&quot;Transform&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a zero transform with a batch shape.&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">Transform</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">maths</span><span class="o">.</span><span class="n">quat_to_3x3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spatial</span><span class="o">.</span><span class="n">quadrants</span><span class="p">(</span><span class="n">aa</span><span class="o">=</span><span class="n">E</span><span class="p">,</span> <span class="n">bb</span><span class="o">=</span><span class="n">E</span><span class="p">)</span> <span class="o">@</span> <span class="n">spatial</span><span class="o">.</span><span class="n">xlt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h5 id="src.ring.base.Transform.zero" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">zero</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">())</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.ring.base.Transform.zero" class="headerlink" title="Permanent link">¤</a></h5>


  <div class="doc doc-contents ">
  
      <p>Returns a zero transform with a batch shape.</p>

          <details class="quote">
            <summary>Source code in <code>src/ring/base.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">zero</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="s2">&quot;Transform&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a zero transform with a batch shape.&quot;&quot;&quot;</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">Transform</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../notebooks/knee_angle_tracking/" class="btn btn-neutral float-left" title="Knee angle tracking"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../notebooks/knee_angle_tracking/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../javascripts/mathjax.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
