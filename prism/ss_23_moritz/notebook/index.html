<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ring.com/prism/ss_23_moritz/notebook/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Notebook - ring</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../../css/ansi-colours.css" rel="stylesheet" />
        <link href="../../../css/jupyter-cells.css" rel="stylesheet" />
        <link href="../../../css/pandas-dataframe.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Notebook";
        var mkdocs_page_input_path = "prism/ss_23_moritz/notebook.ipynb";
        var mkdocs_page_url = "/prism/ss_23_moritz/notebook/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../..">
          <img src="../../../img/icon.svg" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Examples / Notebooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/getting_started/">Getting started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/batched_simulation/">Batched simulation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/control/">Control</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/custom_joint_type/">Custom joint type</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/experimental_data/">Experimental data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/error_quaternion/">Error quaternion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/machine_learning/">Machine learning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/visualisation/">Visualisation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../notebooks/knee_angle_tracking/">Knee angle tracking</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/">ring</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">ring</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Notebook</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
(function() {
  function addWidgetsRenderer() {
    var requireJsScript = document.createElement('script');
    requireJsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js';

    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var jupyterWidgetsScript = document.createElement('script');
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        widgetRendererSrc = 'jupyter-js-widgets@*/dist/embed.js';
      }
    } catch(e) {}

    jupyterWidgetsScript.src = widgetRendererSrc;

    document.body.appendChild(requireJsScript);
    document.body.appendChild(jupyterWidgetsScript);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="training-the-rnno-with-a-custom-loss-function">Training the RNNo with a custom loss function<a class="headerlink" href="#training-the-rnno-with-a-custom-loss-function" title="Permanent link">造</a></h1>
<p>This notebook showcases how train an RNNo network with a custom loss function rather than the default mean-reduces angle error. This is showcased by scaling the error by a softmax over the time axis, which puts more weight on the time intervals with a higher deviation compared to ones with lower deviation.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">tree_utils</span>
<span class="kn">from</span> <span class="nn">jax.nn</span> <span class="kn">import</span> <span class="n">softmax</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mediapy</span>

<span class="kn">import</span> <span class="nn">x_xy</span>
<span class="kn">from</span> <span class="nn">x_xy.subpkgs</span> <span class="kn">import</span> <span class="n">ml</span><span class="p">,</span> <span class="n">sim2real</span><span class="p">,</span> <span class="n">sys_composer</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Set the batch size and number of training episodes according to the available hardware.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">BATCHSIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">NUM_TRAINING_EPISODES</span> <span class="o">=</span> <span class="mi">1500</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="defining-the-systems">Defining the systems<a class="headerlink" href="#defining-the-systems" title="Permanent link">造</a></h2>
<p>We use two separate systems, both parsed from XML strings: one for training (<code>sys</code>) and one for inference (<code>dustin_sys</code>).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">sys_str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;x_xy model=&quot;three_segment_kinematic_chain&quot;&gt;</span>
<span class="s2">&lt;options dt=&quot;0.01&quot; gravity=&quot;0 0 9.81&quot;&gt;&lt;/options&gt;</span>
<span class="s2">&lt;defaults&gt;</span>
<span class="s2">&lt;geom color=&quot;orange&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;/defaults&gt;</span>
<span class="s2">&lt;worldbody&gt;</span>
<span class="s2">&lt;body joint=&quot;free&quot; name=&quot;seg2&quot; pos=&quot;0 0 2&quot;&gt;</span>
<span class="s2">&lt;geom dim=&quot;1 0.25 0.2&quot; mass=&quot;0.1&quot; pos=&quot;0.5 0 0&quot; type=&quot;box&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;body joint=&quot;ry&quot; name=&quot;seg1&quot;&gt;</span>
<span class="s2">&lt;geom dim=&quot;1 0.25 0.2&quot; mass=&quot;0.1&quot; pos=&quot;-0.5 0 0&quot; type=&quot;box&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;body joint=&quot;frozen&quot; name=&quot;imu1&quot; pos=&quot;-0.5 0 0.125&quot;&gt;</span>
<span class="s2">&lt;geom color=&quot;red&quot; dim=&quot;0.2 0.2 0.05&quot; mass=&quot;0.05&quot; type=&quot;box&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;body joint=&quot;rz&quot; name=&quot;seg3&quot; pos=&quot;1 0 0&quot;&gt;</span>
<span class="s2">&lt;geom dim=&quot;1 0.25 0.2&quot; mass=&quot;0.1&quot; pos=&quot;0.5 0 0&quot; type=&quot;box&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;body joint=&quot;frozen&quot; name=&quot;imu2&quot; pos=&quot;0.5 0 -0.125&quot;&gt;</span>
<span class="s2">&lt;geom color=&quot;red&quot; dim=&quot;0.2 0.2 0.05&quot; mass=&quot;0.05&quot; type=&quot;box&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/worldbody&gt;</span>
<span class="s2">&lt;/x_xy&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">sys</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_sys_from_str</span><span class="p">(</span><span class="n">sys_str</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">dustin_exp_xml_seg1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;x_xy model=&quot;dustin_exp&quot;&gt;</span>
<span class="s2">&lt;options dt=&quot;0.01&quot; gravity=&quot;0 0 9.81&quot;&gt;&lt;/options&gt;</span>
<span class="s2">&lt;defaults&gt;</span>
<span class="s2">&lt;geom color=&quot;white&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;/defaults&gt;</span>
<span class="s2">&lt;worldbody&gt;</span>
<span class="s2">&lt;body joint=&quot;free&quot; name=&quot;seg1&quot;&gt;</span>
<span class="s2">&lt;geom dim=&quot;1 0.25 0.2&quot; mass=&quot;10&quot; pos=&quot;-0.5 0 0&quot; type=&quot;box&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;body joint=&quot;ry&quot; name=&quot;seg2&quot;&gt;</span>
<span class="s2">&lt;geom dim=&quot;1 0.25 0.2&quot; mass=&quot;10&quot; pos=&quot;0.5 0 0&quot; type=&quot;box&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;body joint=&quot;rz&quot; name=&quot;seg3&quot; pos=&quot;0.2 0 0&quot;&gt;</span>
<span class="s2">&lt;geom dim=&quot;1 0.25 0.2&quot; mass=&quot;10&quot; pos=&quot;0.5 0 0&quot; type=&quot;box&quot;&gt;&lt;/geom&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/worldbody&gt;</span>
<span class="s2">&lt;/x_xy&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">sys_inference</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_sys_from_str</span><span class="p">(</span><span class="n">dustin_exp_xml_seg1</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="generating-the-motion-data">Generating the motion data<a class="headerlink" href="#generating-the-motion-data" title="Permanent link">造</a></h2>
<p>Our motion data will be automatically generated using a <code>Generator</code>, which can be customised using an <code>MotionConfig</code>. The <code>Generator</code> will generate data for both <code>q</code>, that is the state of all the joint angles in the system, as well as <code>xs</code>, which describes the orientations of all the links in the system. To use this data for training our RNNo, we first have to bring it into the correct form using a <code>finalise_fn</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">finalise_fn</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">xs</span><span class="p">:</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">Transform</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">System</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">xs_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">xs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">name_to_idx</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">consume</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># the input X to our RNNo is the IMU data of segments 1 and 3</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;seg1&quot;</span><span class="p">:</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">imu</span><span class="p">(</span><span class="n">xs_by_name</span><span class="p">(</span><span class="s2">&quot;imu1&quot;</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">gravity</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">consume</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;seg3&quot;</span><span class="p">:</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">imu</span><span class="p">(</span><span class="n">xs_by_name</span><span class="p">(</span><span class="s2">&quot;imu2&quot;</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">gravity</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">consume</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># seg2 has no IMU, but we still need to make an entry in our X</span>
    <span class="n">X</span><span class="p">[</span><span class="s2">&quot;seg2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">tree_zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;seg1&quot;</span><span class="p">])</span>

    <span class="c1"># the output of the RNNo is the estimated relative poses of our segments</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">rel_pose</span><span class="p">(</span><span class="n">sys_scan</span><span class="o">=</span><span class="n">sys_inference</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">sys_xs</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">MotionConfig</span><span class="p">(</span><span class="n">dpos_max</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ang0_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ang0_max</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

<span class="n">gen</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">build_generator</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">finalize_fn</span><span class="o">=</span><span class="n">finalise_fn</span><span class="p">)</span>
<span class="n">gen</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">batch_generator</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">BATCHSIZE</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="custom-loss-function">Custom loss function<a class="headerlink" href="#custom-loss-function" title="Permanent link">造</a></h2>
<p>To customise the loss function of the RNNo, we transform the error values before they are averaged. The input to our loss function will be both <span class="arithmatex">\(q\)</span>, the real joint state, as well as <span class="arithmatex">\(\hat{q}\)</span>, the joint space estimated by our RNNo. <code>q</code> and <code>q_hat</code> will both be <code>jax.Array</code>s of shape <code>(T_tbp, 4)</code>, where the first axis is slice over time (of our TBPTT length) and the second axis are the 4 components of a quaternion.</p>
<p>In this notebook we want to change the relative weightings of the errors at different times using a softmax function in order to put more weight on larger errors. First we convert the errors from quaterions to angles. Then we scale each error angle by a factor, calculated from a softmax over the angles. The calculation of the factors includes a call to <code>jax.lax.stop_gradient</code> to make it so our gradients are only from the errors themselves, not the factors as well.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_loss_fn</span><span class="p">(</span><span class="n">beta</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">metric_fn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q_hat</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">angle_error</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q_hat</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q_hat</span><span class="p">):</span>
            <span class="c1"># q.shape == q_hat.shape == (1000, 4)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">metric_fn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q_hat</span><span class="p">)</span>

            <span class="n">factors</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">softmax</span><span class="p">(</span>
                <span class="n">beta</span> <span class="o">*</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="n">errors</span> <span class="o">=</span> <span class="n">factors</span> <span class="o">*</span> <span class="n">angles</span>

            <span class="k">return</span> <span class="n">errors</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">metric_fn</span>

    <span class="k">return</span> <span class="n">loss_fn</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>beta</code> determines the strength of our weighting: the larger beta, the more relative weight we put on the larger errors, while <code>beta = 0.0</code> makes the scaling factors uniform one and gives us back our unweighted errors. Alternatively <code>beta = None</code> bypasses the scaling altogether. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">beta</span> <span class="o">=</span> <span class="mf">1.0</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">rnno</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">make_rnno</span><span class="p">(</span><span class="n">sys_inference</span><span class="p">)</span>

<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">make_loss_fn</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>

<span class="n">save_params</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">SaveParamsTrainingLoopCallback</span><span class="p">(</span>
    <span class="s2">&quot;parameters.pickle&quot;</span><span class="p">,</span> <span class="n">upload</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">ml</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">NUM_TRAINING_EPISODES</span><span class="p">,</span> <span class="n">rnno</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">save_params</span><span class="p">],</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To visualise our network, we can render it using mediapy. First we generate some motion data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">gen</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">build_generator</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">q</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We need to again bring the motion data in the correct form for our RNNo and can then run inference of the generated data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">params</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;parameters.pickle&quot;</span><span class="p">)</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">finalise_fn</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">add_batch_dim</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">rnno</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">add_batch_dim</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="n">y_hat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rnno</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">to_2d_if_3d</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we want to plot the angle error for both segment 2 and segment 3 over time.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">y</span><span class="p">[</span><span class="s2">&quot;seg2&quot;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">y_hat</span><span class="p">[</span><span class="s2">&quot;seg2&quot;</span><span class="p">]</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">angle_error2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">x_xy</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">angle_error</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;seg2&quot;</span><span class="p">],</span> <span class="n">y_hat</span><span class="p">[</span><span class="s2">&quot;seg2&quot;</span><span class="p">]))</span>
<span class="n">angle_error3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">x_xy</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">angle_error</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;seg3&quot;</span><span class="p">],</span> <span class="n">y_hat</span><span class="p">[</span><span class="s2">&quot;seg3&quot;</span><span class="p">]))</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">angle_error2</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">sys_inference</span><span class="o">.</span><span class="n">dt</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">angle_error2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;seg2&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">angle_error3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;seg3&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time [s]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;abs. angle error [deg]&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next we have to create an <code>xs_hat</code> of the estimated orientations, so that we can render them.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># Extract translations from data-generating system...</span>
<span class="n">translations</span><span class="p">,</span> <span class="n">rotations</span> <span class="o">=</span> <span class="n">sim2real</span><span class="o">.</span><span class="n">unzip_xs</span><span class="p">(</span>
    <span class="n">sys_inference</span><span class="p">,</span> <span class="n">sim2real</span><span class="o">.</span><span class="n">match_xs</span><span class="p">(</span><span class="n">sys_inference</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">y_hat_inv</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">quat</span><span class="p">:</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">quat_inv</span><span class="p">(</span><span class="n">quat</span><span class="p">),</span> <span class="n">y_hat</span><span class="p">)</span> 

<span class="c1"># ... swap rotations with predicted ones...</span>
<span class="n">rotations_hat</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sys_inference</span><span class="o">.</span><span class="n">link_names</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">y_hat_inv</span><span class="p">:</span>
        <span class="n">rotations_name</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">Transform</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">rot</span><span class="o">=</span><span class="n">y_hat_inv</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rotations_name</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rotations_hat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotations_name</span><span class="p">)</span>

<span class="c1"># ... and plug the positions and rotations back together.</span>
<span class="n">rotations_hat</span> <span class="o">=</span> <span class="n">rotations_hat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="o">*</span><span class="n">rotations_hat</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">xs_hat</span> <span class="o">=</span> <span class="n">sim2real</span><span class="o">.</span><span class="n">zip_xs</span><span class="p">(</span><span class="n">sys_inference</span><span class="p">,</span> <span class="n">translations</span><span class="p">,</span> <span class="n">rotations_hat</span><span class="p">)</span>

<span class="c1"># Create combined system that shall be rendered and its transforms</span>
<span class="n">sys_render</span> <span class="o">=</span> <span class="n">sys_composer</span><span class="o">.</span><span class="n">inject_system</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">sys_inference</span><span class="o">.</span><span class="n">add_prefix_suffix</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_hat&quot;</span><span class="p">))</span>
<span class="n">xs_render</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">Transform</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">xs_hat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can render both the predicted system (in white) as well as the real system (in orange).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">xs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">xs_render</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xs_render</span><span class="o">.</span><span class="n">shape</span><span class="p">())]</span>

<span class="n">frames</span> <span class="o">=</span> <span class="n">x_xy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">sys_render</span><span class="p">,</span> <span class="n">xs_list</span><span class="p">,</span> <span class="n">camera</span><span class="o">=</span><span class="s2">&quot;targetfar&quot;</span><span class="p">)</span>
<span class="n">mediapy</span><span class="o">.</span><span class="n">show_video</span><span class="p">([</span><span class="n">frame</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">],</span> <span class="n">fps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sys</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>
</code></pre></div>

</div>
</div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../javascripts/mathjax.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
